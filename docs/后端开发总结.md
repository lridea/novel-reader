# å°è¯´æŸ¥è¯¢å¢å¼ºåŠŸèƒ½ - åç«¯å¼€å‘æ€»ç»“

**å¼€å‘æ—¶é—´**: 2026-02-18
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

### å®ç°çš„åŠŸèƒ½

| åºå· | åŠŸèƒ½ | æè¿° | çŠ¶æ€ |
|------|------|------|------|
| 1 | æŒ‰çŠ¶æ€ç­›é€‰ | æ”¯æŒæŒ‰å°è¯´çŠ¶æ€ï¼ˆè¿è½½ä¸­/å·²å®Œç»“/åœæ›´ï¼‰ç­›é€‰ | âœ… å·²å®ç° |
| 2 | æŒ‰æ ‡ç­¾ç­›é€‰ | æ”¯æŒæŒ‰æ ‡ç­¾ç­›é€‰ï¼ˆå•é€‰ï¼Œä»å·²æœ‰æ ‡ç­¾ä¸­é€‰æ‹©ï¼‰ | âœ… å·²å®ç° |
| 3 | æŒ‰å­—æ•°èŒƒå›´ç­›é€‰ | æ”¯æŒæŒ‰å­—æ•°èŒƒå›´ç­›é€‰ï¼ˆæ”¯æŒå¤§äºæˆ–è€…å°äºï¼‰ | âœ… å·²å®ç° |
| 4 | æ’åºæ–¹å¼å¢å¼º | æ”¯æŒæŒ‰å­—æ•°é™åº/å‡åºã€æŒ‰æ›´æ–°æ—¶é—´é™åº/å‡åº | âœ… å·²å®ç° |

---

## ğŸ—‚ï¸ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `novel-reader-backend/src/main/java/com/novelreader/controller/TagsController.java` | æ ‡ç­¾Controller |
| `novel-reader-backend/src/test/java/com/novelreader/controller/TagsControllerTest.java` | TagsControllerå•å…ƒæµ‹è¯• |
| `novel-reader-backend/src/test/java/com/novelreader/controller/CrawlerControllerTest.java` | CrawlerControllerå•å…ƒæµ‹è¯• |
| `novel-reader-backend/src/test/java/com/novelreader/repository/NovelRepositoryTest.java` | NovelRepositoryå•å…ƒæµ‹è¯• |
| `novel-reader-backend/src/main/resources/db/migration/V2__add_indexes.sql` | æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–è„šæœ¬ |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `novel-reader-backend/src/main/java/com/novelreader/repository/NovelRepository.java` | æ–°å¢æŸ¥è¯¢æ–¹æ³• |
| `novel-reader-backend/src/main/java/com/novelreader/controller/CrawlerController.java` | æ›´æ–°getNovelsPageæ¥å£ |
| `novel-reader/APIæ–‡æ¡£.md` | æ›´æ–°APIæ–‡æ¡£ |

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. NovelRepositoryæ–°å¢æŸ¥è¯¢æ–¹æ³•

#### å¤æ‚æŸ¥è¯¢æ–¹æ³•
```java
@Query("SELECT n FROM Novel n WHERE n.deleted = 0 " +
       "AND (:platform IS NULL OR n.platform = :platform) " +
       "AND (:keyword IS NULL OR n.title LIKE %:keyword% OR n.author LIKE %:keyword%) " +
       "AND (:status IS NULL OR n.status = :status) " +
       "AND (:tag IS NULL OR n.tags LIKE %:tag%) " +
       "AND (:wordCountMin IS NULL OR n.wordCount >= :wordCountMin) " +
       "AND (:wordCountMax IS NULL OR n.wordCount <= :wordCountMax)")
Page<Novel> searchNovels(
    @Param("platform") String platform,
    @Param("keyword") String keyword,
    @Param("status") Integer status,
    @Param("tag") String tag,
    @Param("wordCountMin") Long wordCountMin,
    @Param("wordCountMax") Long wordCountMax,
    Pageable pageable);
```

**ç‰¹ç‚¹**ï¼š
- æ”¯æŒå¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢
- å‚æ•°ä¸ºnullæ—¶å¿½ç•¥è¯¥æ¡ä»¶
- ä½¿ç”¨åŠ¨æ€SQLï¼Œçµæ´»æ€§å¼º

#### æ ‡ç­¾æŸ¥è¯¢æ–¹æ³•ï¼ˆåŸç”ŸSQLï¼‰
```java
@Query(value = "SELECT JSON_UNQUOTE(JSON_EXTRACT(tags, CONCAT('$[', seq.seq, ']'))) as tag_name, " +
               "COUNT(*) as tag_count " +
               "FROM t_novel, " +
               "(SELECT 0 AS seq UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) seq " +
               "WHERE JSON_LENGTH(tags) > seq.seq " +
               "AND deleted = 0 " +
               "GROUP BY tag_name " +
               "ORDER BY tag_count DESC " +
               "LIMIT 100", nativeQuery = true)
List<Map<String, Object>> getAllTags();
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨MySQL JSONå‡½æ•°è§£ææ ‡ç­¾
- æ”¯æŒè·¨è¡Œæå–æ ‡ç­¾ï¼ˆseq 0-9ï¼‰
- æŒ‰å°è¯´æ•°é‡é™åºæ’åº
- æœ€å¤šè¿”å›100ä¸ªæ ‡ç­¾

### 2. CrawlerControlleræ›´æ–°

#### getNovelsPageæ¥å£å‚æ•°æ‰©å±•
```java
@GetMapping("/novels/page")
public ResponseEntity<Map<String, Object>> getNovelsPage(
    @RequestParam(defaultValue = "0") int page,
    @RequestParam(defaultValue = "10") int size,
    @RequestParam(required = false) String platform,
    @RequestParam(required = false) String keyword,
    @RequestParam(required = false) Integer status,
    @RequestParam(required = false) String tag,
    @RequestParam(required = false) String wordCountMin,
    @RequestParam(required = false) String wordCountMax,
    @RequestParam(defaultValue = "updateTime") String sortBy,
    @RequestParam(defaultValue = "desc") String sortOrder)
```

#### å­—æ•°èŒƒå›´è§£ææ–¹æ³•
```java
private Long parseWordCount(String wordCountStr) {
    if (wordCountStr == null || wordCountStr.isEmpty() || "å…¨éƒ¨".equals(wordCountStr)) {
        return null;
    }

    try {
        String lower = wordCountStr.toLowerCase();
        if (lower.equals("10w") || lower.equals("100000")) {
            return 100000L;
        } else if (lower.equals("30w") || lower.equals("300000")) {
            return 300000L;
        } else if (lower.equals("50w") || lower.equals("500000")) {
            return 500000L;
        } else if (lower.equals("100w") || lower.equals("1000000")) {
            return 1000000L;
        } else if (lower.equals("200w") || lower.equals("2000000")) {
            return 2000000L;
        } else {
            return Long.parseLong(wordCountStr);
        }
    } catch (NumberFormatException e) {
        log.warn("è§£æå­—æ•°å‚æ•°å¤±è´¥: {}", wordCountStr);
        return null;
    }
}
```

**ç‰¹ç‚¹**ï¼š
- æ”¯æŒ10wã€30wã€50wã€100wã€200wæ ¼å¼
- å…¼å®¹çº¯æ•°å­—æ ¼å¼ï¼ˆ100000ï¼‰
- è§£æå¤±è´¥è¿”å›nullï¼ˆå¿½ç•¥è¯¥æ¡ä»¶ï¼‰

### 3. TagsControlleræ–°å¢

#### è·å–æ‰€æœ‰æ ‡ç­¾
```java
@GetMapping
public ResponseEntity<Map<String, Object>> getAllTags()
```

#### è·å–æŒ‡å®šå¹³å°çš„æ ‡ç­¾
```java
@GetMapping("/platform/{platform}")
public ResponseEntity<Map<String, Object>> getTagsByPlatform(@PathVariable String platform)
```

**ç‰¹ç‚¹**ï¼š
- è¿”å›æ ‡ç­¾åç§°å’Œå°è¯´æ•°é‡
- æ”¯æŒæŒ‰å¹³å°ç­›é€‰
- é”™è¯¯å¤„ç†å‹å¥½

### 4. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

#### æ–°å¢ç´¢å¼•
- `idx_word_count` - å­—æ•°å­—æ®µç´¢å¼•
- `idx_platform_status_word_count` - å¹³å°+çŠ¶æ€+å­—æ•°å¤åˆç´¢å¼•
- `idx_status_word_count_update_time` - çŠ¶æ€+å­—æ•°+æ›´æ–°æ—¶é—´å¤åˆç´¢å¼•
- `idx_platform_update_time` - å¹³å°+æ›´æ–°æ—¶é—´å¤åˆç´¢å¼•

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨åŠ¨æ€SQLé¿å…å­—æ®µå·²å­˜åœ¨æ—¶æŠ¥é”™
- ä½¿ç”¨CREATE INDEX IF NOT EXISTSé¿å…ç´¢å¼•å·²å­˜åœ¨æ—¶æŠ¥é”™
- ç´¢å¼•è®¾è®¡éµå¾ª"æœ€å·¦å‰ç¼€åŸåˆ™"

---

## ğŸ§ª å•å…ƒæµ‹è¯•

### NovelRepositoryTest

| æµ‹è¯•æ–¹æ³• | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|
| testFindByPlatformAndNovelId | æ ¹æ®å¹³å°å’Œå°è¯´IDæŸ¥æ‰¾ | âœ… |
| testFindByPlatform | æ ¹æ®å¹³å°æŸ¥æ‰¾ | âœ… |
| testFindByStatus | æ ¹æ®çŠ¶æ€æŸ¥æ‰¾ | âœ… |
| testSearchByKeyword | æ ¹æ®å…³é”®è¯æœç´¢ | âœ… |
| testSearchByPlatformAndKeyword | æ ¹æ®å¹³å°å’Œå…³é”®è¯æœç´¢ | âœ… |
| testSearchNovels_AllParameters | æ‰€æœ‰å‚æ•° | âœ… |
| testSearchNovels_OnlyStatus | ä»…çŠ¶æ€ | âœ… |
| testSearchNovels_OnlyTag | ä»…æ ‡ç­¾ | âœ… |
| testSearchNovels_WordCountRange | å­—æ•°èŒƒå›´ | âœ… |
| testGetAllTags | è·å–æ‰€æœ‰æ ‡ç­¾ | âœ… |
| testGetTagsByPlatform | æ ¹æ®å¹³å°è·å–æ ‡ç­¾ | âœ… |

### TagsControllerTest

| æµ‹è¯•æ–¹æ³• | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|
| testGetAllTags | è·å–æ‰€æœ‰æ ‡ç­¾ | âœ… |
| testGetTagsByPlatform | æ ¹æ®å¹³å°è·å–æ ‡ç­¾ | âœ… |
| testGetTagsByPlatform_NotExists | å¹³å°ä¸å­˜åœ¨ | âœ… |

### CrawlerControllerTest

| æµ‹è¯•æ–¹æ³• | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|
| testGetNovelsPage_AllParameters | æ‰€æœ‰å‚æ•° | âœ… |
| testGetNovelsPage_OnlyStatus | ä»…çŠ¶æ€ | âœ… |
| testGetNovelsPage_OnlyTag | ä»…æ ‡ç­¾ | âœ… |
| testGetNovelsPage_SortByWordCount | æŒ‰å­—æ•°æ’åº | âœ… |
| testGetNovelsPage_SortByUpdateTime | æŒ‰æ›´æ–°æ—¶é—´æ’åº | âœ… |
| testGetNovelsPage_WordCountMinOnly | ä»…æœ€å°å­—æ•° | âœ… |
| testGetNovelsPage_WordCountMaxOnly | ä»…æœ€å¤§å­—æ•° | âœ… |
| testGetNovelsPage_WordCountRange | å­—æ•°èŒƒå›´ | âœ… |
| testGetNovelsPage_WordCountInvalid | å­—æ•°å‚æ•°æ— æ•ˆ | âœ… |
| testGetNovelsPage_DefaultParameters | é»˜è®¤å‚æ•° | âœ… |
| testGetCrawlerStatus | è·å–çˆ¬è™«çŠ¶æ€ | âœ… |
| testGetAllConfigs | è·å–æ‰€æœ‰é…ç½® | âœ… |
| testGetAllCrawlers | è·å–æ‰€æœ‰çˆ¬è™« | âœ… |
| testHealth | å¥åº·æ£€æŸ¥ | âœ… |

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢æ€§èƒ½é¢„ä¼°

| æ•°æ®é‡ | æŸ¥è¯¢æ¡ä»¶ | ç´¢å¼•ä½¿ç”¨ | é¢„ä¼°è€—æ—¶ |
|--------|---------|---------|---------|
| 1ä¸‡æ¡ | å•æ¡ä»¶ï¼ˆçŠ¶æ€ï¼‰ | âœ… idx_status | < 50ms |
| 1ä¸‡æ¡ | ç»„åˆæ¡ä»¶ï¼ˆçŠ¶æ€+å­—æ•°ï¼‰ | âœ… idx_status_word_count | < 80ms |
| 1ä¸‡æ¡ | å¤æ‚æŸ¥è¯¢ï¼ˆ4+æ¡ä»¶ï¼‰ | âœ… å¤åˆç´¢å¼• | < 150ms |
| 10ä¸‡æ¡ | å•æ¡ä»¶ï¼ˆçŠ¶æ€ï¼‰ | âœ… idx_status | < 100ms |
| 10ä¸‡æ¡ | ç»„åˆæ¡ä»¶ï¼ˆçŠ¶æ€+å­—æ•°ï¼‰ | âœ… idx_status_word_count | < 200ms |
| 10ä¸‡æ¡ | å¤æ‚æŸ¥è¯¢ï¼ˆ4+æ¡ä»¶ï¼‰ | âš ï¸ å¤åˆç´¢å¼• | < 500ms |

### ç´¢å¼•è®¾è®¡åŸåˆ™

1. **å•åˆ—ç´¢å¼•**ï¼šç”¨äºå•æ¡ä»¶æŸ¥è¯¢ï¼ˆstatus, wordCountï¼‰
2. **å¤åˆç´¢å¼•**ï¼šç”¨äºå¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢
3. **ç´¢å¼•å­—æ®µé¡ºåº**ï¼šæŒ‰ç…§æŸ¥è¯¢é¢‘ç‡å’ŒåŒºåˆ†åº¦æ’åˆ—
4. **é¿å…è¿‡åº¦ç´¢å¼•**ï¼šè€ƒè™‘å†™å…¥æ€§èƒ½å½±å“

---

## ğŸŒ APIæ¥å£

### æ–°å¢æ¥å£

| æ¥å£è·¯å¾„ | æ–¹æ³• | æè¿° |
|---------|------|------|
| `/api/crawler/novels/tags` | GET | è·å–æ‰€æœ‰æ ‡ç­¾ |
| `/api/crawler/novels/tags/platform/{platform}` | GET | è·å–æŒ‡å®šå¹³å°çš„æ ‡ç­¾ |

### æ›´æ–°æ¥å£

| æ¥å£è·¯å¾„ | æ–¹æ³• | æ›´æ–°å†…å®¹ |
|---------|------|---------|
| `/api/crawler/novels/page` | GET | æ–°å¢ç­›é€‰å‚æ•°ï¼šstatus, tag, wordCountMin, wordCountMax, sortBy, sortOrder |

---

## âœ… å¼€å‘å®ŒæˆçŠ¶æ€

| ä»»åŠ¡ | çŠ¶æ€ |
|------|------|
| NovelRepositoryæ–°å¢æŸ¥è¯¢æ–¹æ³• | âœ… å·²å®Œæˆ |
| CrawlerControlleræ›´æ–°æ¥å£ | âœ… å·²å®Œæˆ |
| æ–°å¢TagsController | âœ… å·²å®Œæˆ |
| æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– | âœ… å·²å®Œæˆ |
| å•å…ƒæµ‹è¯•ç¼–å†™ | âœ… å·²å®Œæˆ |
| APIæ–‡æ¡£æ›´æ–° | âœ… å·²å®Œæˆ |

---

## ğŸ“ å¾…åŠäº‹é¡¹

- [ ] è¿è¡Œå•å…ƒæµ‹è¯•éªŒè¯
- [ ] å‰ç«¯å¼€å‘
- [ ] å‰åç«¯è”è°ƒ
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] Bugä¿®å¤

---

## ğŸ¯ Gitæäº¤è®°å½•

### æäº¤1ï¼šåç«¯å®ç°
```
feat: å®ç°å°è¯´æŸ¥è¯¢å¢å¼ºåŠŸèƒ½åç«¯éƒ¨åˆ†
æäº¤ID: 49e1882
```

### æäº¤2ï¼šæ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
```
db: æ·»åŠ æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
æäº¤ID: 24410b4
```

### æäº¤3ï¼šAPIæ–‡æ¡£æ›´æ–°
```
docs: æ›´æ–°APIæ–‡æ¡£ï¼Œæ·»åŠ å°è¯´æŸ¥è¯¢å¢å¼ºåŠŸèƒ½æ¥å£
æäº¤ID: 9f4c623
```

### GitHubæ¨é€è®°å½•

- **æ¨é€æ—¶é—´**: 2026-02-18 11:00
- **æ¨é€çŠ¶æ€**: âœ… æˆåŠŸ
- **ä»“åº“**: https://github.com/lridea/novel-reader
- **åˆ†æ”¯**: master
- **æœ€æ–°æäº¤**: 9f4c623

---

**å¼€å‘å®Œæˆæ—¶é—´**: 2026-02-18 11:00  
**å¼€å‘äººå‘˜**: OpenClaw  
**GitHubä»“åº“**: https://github.com/lridea/novel-reader  
**åç«¯çŠ¶æ€**: âœ… å·²å®Œæˆ  

ğŸ¦
