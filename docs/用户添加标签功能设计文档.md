# 用户添加标签功能设计文档

**设计日期**: 2026-02-18
**设计人员**: OpenClaw
**版本**: v1.0

---

## 📋 需求分析

### 1. 功能需求

| 序号 | 功能需求 | 说明 |
|------|---------|------|
| 1 | 用户添加标签 | 用户可以为书籍添加自定义标签 |
| 2 | 管理员审核 | 管理员可以审核用户提交的标签 |
| 3 | 标签入库 | 审核通过的标签正式入库 |
| 4 | 标签区分 | 用户标签和系统标签需要区分 |
| 5 | 查询过滤 | 用户标签可以在查询界面进行过滤 |

---

### 2. 非功能需求

| 序号 | 需求 | 说明 |
|------|------|------|
| 1 | 权限控制 | 用户添加标签需要登录，管理员审核需要管理员权限 |
| 2 | 数据一致性 | 唯一约束确保同一用户对同一本书不能重复添加相同标签 |
| 3 | 审核流程 | 标签需要审核才能正式入库 |
| 4 | 性能优化 | 添加索引提高查询性能 |

---

## 🗄️ 数据库设计

### 1. 标签审核表（t_tag_audit）

**表名**: `t_tag_audit`

**表结构**:

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键ID | PRIMARY KEY, AUTO_INCREMENT |
| novel_id | BIGINT | 书籍ID | NOT NULL |
| user_id | BIGINT | 用户ID | NOT NULL |
| tag | VARCHAR(100) | 标签名称 | NOT NULL |
| status | TINYINT | 审核状态（0-待审核, 1-已通过, 2-已拒绝）| NOT NULL, DEFAULT 0 |
| created_at | TIMESTAMP | 创建时间 | NOT NULL, DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | 更新时间 | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |
| reviewed_by | BIGINT | 审核人ID | |
| reviewed_at | TIMESTAMP | 审核时间 | |
| reason | VARCHAR(500) | 拒绝原因 | |

**索引**:
```sql
CREATE INDEX idx_novel_id ON t_tag_audit(novel_id);
CREATE INDEX idx_user_id ON t_tag_audit(user_id);
CREATE INDEX idx_status ON t_tag_audit(status);
CREATE INDEX idx_created_at ON t_tag_audit(created_at);

-- 唯一约束：同一用户对同一本书不能重复添加相同标签
CREATE UNIQUE INDEX uk_user_novel_tag ON t_tag_audit(user_id, novel_id, tag);
```

---

### 2. 用户标签表（t_user_tag）

**表名**: `t_user_tag`

**表结构**:

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | BIGINT | 主键ID | PRIMARY KEY, AUTO_INCREMENT |
| novel_id | BIGINT | 书籍ID | NOT NULL |
| user_id | BIGINT | 用户ID | NOT NULL |
| tag | VARCHAR(100) | 标签名称 | NOT NULL |
| created_at | TIMESTAMP | 创建时间 | NOT NULL, DEFAULT CURRENT_TIMESTAMP |

**索引**:
```sql
CREATE INDEX idx_novel_id ON t_user_tag(novel_id);
CREATE INDEX idx_user_id ON t_user_tag(user_id);
CREATE INDEX idx_tag ON t_user_tag(tag);

-- 唯一约束：同一用户对同一本书不能重复添加相同标签
CREATE UNIQUE INDEX uk_user_novel_tag ON t_user_tag(user_id, novel_id, tag);
```

---

### 3. Novel实体修改

**修改内容**：添加`userTags`字段

**字段说明**:
| 字段名 | 类型 | 说明 | 存储格式 |
|--------|------|------|---------|
| userTags | TEXT | 用户标签列表（JSON数组格式）| ["玄幻", "修仙"] |

**与原标签字段区分**:
- `tags`: 系统标签（爬虫抓取）
- `userTags`: 用户标签（用户添加）

---

## 🌐 接口设计

### 1. 用户接口

#### 1.1 添加标签

**接口路径**: `POST /api/tags/user`

**权限**: 需要登录 (`isAuthenticated`)

**请求体**:
```json
{
  "novelId": 1,
  "tag": "玄幻"
}
```

**响应格式**:
```json
{
  "success": true,
  "message": "标签提交成功，等待审核"
}
```

---

#### 1.2 查询我的标签

**接口路径**: `GET /api/tags/user/my`

**权限**: 需要登录 (`isAuthenticated`)

**查询参数**:
- `page`: 页码（从0开始，默认0）
- `size`: 每页数量（默认10）
- `status`: 审核状态（可选：0-待审核, 1-已通过, 2-已拒绝）

**响应格式**:
```json
{
  "success": true,
  "content": [
    {
      "id": 1,
      "novelId": 1,
      "novelTitle": "书名",
      "tag": "玄幻",
      "status": 0,
      "createdAt": "2026-02-18T10:00:00"
    }
  ],
  "totalElements": 100,
  "totalPages": 10,
  "size": 10,
  "number": 0
}
```

---

### 2. 管理员接口

#### 2.1 查询待审核标签

**接口路径**: `GET /api/tags/admin/audits`

**权限**: 管理员 (`hasRole('ADMIN')`)

**查询参数**:
- `page`: 页码（从0开始，默认0）
- `size`: 每页数量（默认10）
- `status`: 审核状态（可选：0-待审核, 1-已通过, 2-已拒绝）

**响应格式**:
```json
{
  "success": true,
  "content": [
    {
      "id": 1,
      "novelId": 1,
      "novelTitle": "书名",
      "userId": 1,
      "username": "用户名",
      "tag": "玄幻",
      "status": 0,
      "createdAt": "2026-02-18T10:00:00"
    }
  ],
  "totalElements": 100,
  "totalPages": 10,
  "size": 10,
  "number": 0
}
```

---

#### 2.2 审核标签

**接口路径**: `PUT /api/tags/admin/audits/{id}`

**权限**: 管理员 (`hasRole('ADMIN')`)

**请求体**:
```json
{
  "status": 1,
  "reason": ""
}
```

**请求参数**:
- `status`: 审核状态（1-已通过, 2-已拒绝）
- `reason`: 拒绝原因（拒绝时必填）

**响应格式**:
```json
{
  "success": true,
  "message": "审核成功"
}
```

---

#### 2.3 批量审核标签

**接口路径**: `PUT /api/tags/admin/audits/batch`

**权限**: 管理员 (`hasRole('ADMIN')`)

**请求体**:
```json
{
  "ids": [1, 2, 3],
  "status": 1,
  "reason": ""
}
```

**请求参数**:
- `ids`: 标签审核ID列表
- `status`: 审核状态（1-已通过, 2-已拒绝）
- `reason`: 拒绝原因（拒绝时必填）

**响应格式**:
```json
{
  "success": true,
  "message": "批量审核成功",
  "approveCount": 3,
  "rejectCount": 0
}
```

---

## 🔒 权限设计

### 1. 用户权限

| 接口 | 权限 | 说明 |
|------|------|------|
| `POST /api/tags/user` | 需要登录 | 添加标签 |
| `GET /api/tags/user/my` | 需要登录 | 查询我的标签 |

---

### 2. 管理员权限

| 接口 | 权限 | 说明 |
|------|------|------|
| `GET /api/tags/admin/audits` | 管理员 | 查询待审核标签 |
| `PUT /api/tags/admin/audits/{id}` | 管理员 | 审核标签 |
| `PUT /api/tags/admin/audits/batch` | 管理员 | 批量审核标签 |

---

## 🎨 业务流程

### 1. 用户添加标签流程

```
用户添加标签
  ↓
检查用户是否登录
  ↓（未登录）
返回错误：请先登录
  ↓（已登录）
检查是否已添加相同标签
  ↓（已添加）
返回错误：已添加该标签
  ↓（未添加）
创建标签审核记录
  ↓
返回成功：标签提交成功，等待审核
```

---

### 2. 管理员审核标签流程

```
管理员审核标签
  ↓
检查是否为管理员
  ↓（非管理员）
返回错误：权限不足
  ↓（管理员）
更新标签审核状态
  ↓
如果是通过，创建用户标签记录
  ↓
更新书籍的userTags字段
  ↓
返回成功：审核成功
```

---

### 3. 标签入库流程

```
标签审核通过
  ↓
创建用户标签记录（t_user_tag）
  ↓
更新书籍的userTags字段
  ↓
更新标签审核记录状态为已通过
  ↓
返回成功：标签已入库
```

---

## 🎨 前端设计

### 1. 用户界面

#### 1.1 添加标签

**位置**: 书籍详情页面

**功能**:
- 输入标签名称
- 点击"添加标签"按钮
- 提示"标签提交成功，等待审核"

---

#### 1.2 我的标签

**位置**: 用户中心

**功能**:
- 展示我添加的所有标签
- 显示审核状态（待审核/已通过/已拒绝）
- 支持分页查询

---

### 2. 管理员界面

#### 2.1 标签审核

**位置**: 管理员后台

**功能**:
- 展示待审核的标签
- 显示标签信息（书名、标签、提交人、提交时间）
- 支持审核通过/拒绝
- 支持批量审核
- 支持分页查询

---

#### 2.2 标签过滤

**位置**: 书籍查询页面

**功能**:
- 展示所有用户标签
- 支持按用户标签过滤书籍
- 用户标签和系统标签分开展示

---

## 📊 数据流程

### 1. 标签添加流程

```
用户添加标签
  → t_tag_audit（status=0）
  → 等待审核
  → 管理员审核
  → t_tag_audit（status=1/2）
  → 如果通过：t_user_tag + Novel.userTags
```

---

### 2. 标签查询流程

```
用户查询书籍
  → Novel.tags（系统标签）
  → Novel.userTags（用户标签）
  → 组合展示
  → 支持过滤
```

---

## 🎯 接口清单

### 用户接口（2个）

| 接口路径 | 方法 | 权限 | 说明 |
|---------|------|------|------|
| `/api/tags/user` | POST | 需要登录 | 添加标签 |
| `/api/tags/user/my` | GET | 需要登录 | 查询我的标签 |

---

### 管理员接口（3个）

| 接口路径 | 方法 | 权限 | 说明 |
|---------|------|------|------|
| `/api/tags/admin/audits` | GET | 管理员 | 查询待审核标签 |
| `/api/tags/admin/audits/{id}` | PUT | 管理员 | 审核标签 |
| `/api/tags/admin/audits/batch` | PUT | 管理员 | 批量审核标签 |

---

## 🎓 技术亮点

### 1. 标签区分

**方式**:
- `Novel.tags`: 系统标签（爬虫抓取）
- `Novel.userTags`: 用户标签（用户添加）

**优点**:
- 清晰区分系统标签和用户标签
- 灵活的标签管理
- 支持标签扩展

---

### 2. 审核流程

**方式**:
- 用户添加标签 → 进入审核队列
- 管理员审核 → 通过/拒绝
- 审核通过 → 标签正式入库

**优点**:
- 确保标签质量
- 避免恶意标签
- 可追溯审核记录

---

### 3. 唯一约束

**方式**:
- 同一用户对同一本书不能重复添加相同标签
- 唯一约束：`uk_user_novel_tag`

**优点**:
- 避免重复标签
- 提高数据质量
- 减少审核压力

---

## 📝 待办事项

### 后端开发

- [x] 创建TagAudit实体类
- [x] 创建UserTag实体类
- [x] 修改Novel实体类（添加userTags字段）
- [x] 创建TagAuditRepository
- [x] 创建UserTagRepository
- [x] 创建TagService
- [x] 创建TagController
- [x] 实现添加标签接口
- [x] 实现查询我的标签接口
- [x] 实现查询待审核标签接口
- [x] 实现审核标签接口
- [x] 实现批量审核标签接口

---

### 前端开发

- [ ] 书籍详情页面：添加标签输入框和按钮
- [ ] 用户中心：我的标签页面
- [ ] 管理员后台：标签审核页面
- [ ] 书籍查询页面：添加用户标签过滤
- [ ] API调用和Mock数据

---

### 数据库迁移

- [x] 创建t_tag_audit表
- [x] 创建t_user_tag表
- [x] 添加userTags字段到t_novel表
- [x] 添加索引和唯一约束

---

## 🏆 总结

### 核心功能

1. ✅ 用户添加标签
2. ✅ 管理员审核
3. ✅ 标签入库
4. ✅ 标签区分
5. ✅ 查询过滤

---

### 技术亮点

1. ✅ 标签区分（系统标签vs用户标签）
2. ✅ 审核流程（待审核→已通过/已拒绝）
3. ✅ 唯一约束（避免重复标签）
4. ✅ 权限控制（用户+管理员）

---

### 后续优化

1. ⚠️ 标签推荐：根据用户历史推荐标签
2. ⚠️ 标签统计：统计热门用户标签
3. ⚠️ 标签管理：标签合并、删除等管理功能

---

**设计完成时间**: 2026-02-18 20:00
**设计人员**: OpenClaw

🦞
