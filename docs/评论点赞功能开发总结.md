# è¯„è®ºç‚¹èµåŠŸèƒ½å¼€å‘æ€»ç»“

**å¼€å‘æ—¥æœŸ**: 2026-02-18
**å¼€å‘äººå‘˜**: OpenClaw
**ç‰ˆæœ¬**: v1.1
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ éœ€æ±‚å®Œæˆæƒ…å†µ

| åºå· | åŠŸèƒ½ | æè¿° | çŠ¶æ€ |
|------|------|------|------|
| 1 | ç‚¹èµè¯„è®º | ç”¨æˆ·å¯ä»¥ç‚¹èµ/å–æ¶ˆç‚¹èµè¯„è®º | âœ… å·²å®ç° |
| 2 | æŒ‰ç‚¹èµæ•°é™åºå±•ç¤º | è¯„è®ºæŒ‰ç‚¹èµæ•°é™åºå±•ç¤º | âœ… å·²å®ç° |
| 3 | ç‚¹èµçŠ¶æ€æ˜¾ç¤º | æ˜¾ç¤ºå½“å‰ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ | âœ… å·²å®ç° |
| 4 | ç‚¹èµæ•°å®æ—¶æ›´æ–° | ç‚¹èµ/å–æ¶ˆç‚¹èµåå®æ—¶æ›´æ–°ç‚¹èµæ•° | âœ… å·²å®ç° |

---

## ğŸ—‚ï¸ æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

| æ–‡ä»¶ | è¯´æ˜ | æäº¤ID |
|------|------|--------|
| `V5__add_comment_like_table.sql` | æ•°æ®åº“è¿ç§»è„šæœ¬ | 270523e |
| `CommentLike.java` | è¯„è®ºç‚¹èµå®ä½“ | 270523e |
| `CommentLikeRepository.java` | è¯„è®ºç‚¹èµRepository | 270523e |
| `CommentRepository.java` | æ–°å¢æŒ‰ç‚¹èµæ•°é™åºæŸ¥è¯¢æ–¹æ³• | 270523e |
| `CommentService.java` | æ·»åŠ ç‚¹èµåŠŸèƒ½ | 270523e |
| `CommentController.java` | æ·»åŠ ç‚¹èµAPI | 270523e |

### å‰ç«¯æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

| æ–‡ä»¶ | è¯´æ˜ | æäº¤ID |
|------|------|--------|
| `api/index.js` | æ–°å¢ç‚¹èµç›¸å…³API | af399d6 |
| `mock.js` | æ–°å¢ç‚¹èµMockæ–¹æ³• | af399d6 |
| `NovelDetail.vue` | æ·»åŠ ç‚¹èµæŒ‰é’®å’ŒåŠŸèƒ½ | bc29529 |

---

## ğŸŒ APIæ¥å£

### 1. ç‚¹èµè¯„è®º

**æ¥å£è·¯å¾„**: `POST /api/comments/{id}/like`

**è·¯å¾„å‚æ•°**ï¼š
- `id`: è¯„è®ºID

**å“åº”æ ¼å¼**ï¼š
```json
{
  "success": true,
  "message": "ç‚¹èµæˆåŠŸ",
  "liked": true,
  "commentLikeCount": 11
}
```

---

### 2. å–æ¶ˆç‚¹èµè¯„è®º

**æ¥å£è·¯å¾„**: `DELETE /api/comments/{id}/like`

**è·¯å¾„å‚æ•°**ï¼š
- `id`: è¯„è®ºID

**å“åº”æ ¼å¼**ï¼š
```json
{
  "success": true,
  "message": "å–æ¶ˆç‚¹èµæˆåŠŸ",
  "liked": false,
  "commentLikeCount": 10
}
```

---

## ğŸ¨ å‰ç«¯ç•Œé¢

### å°è¯´è¯¦æƒ…é¡µé¢ï¼ˆNovelDetail.vueï¼‰

#### ç‚¹èµæŒ‰é’®

**é¡¶å±‚è¯„è®º**ï¼š
- ç‚¹èµæŒ‰é’®ï¼ˆæ˜¾ç¤ºStarFilledå›¾æ ‡å’Œç‚¹èµæ•°ï¼‰
- å·²ç‚¹èµï¼šè“è‰²ï¼ˆprimaryï¼‰æ˜¾ç¤º
- æœªç‚¹èµï¼šé»˜è®¤é¢œè‰²æ˜¾ç¤º
- ç‚¹å‡»ç‚¹èµ/å–æ¶ˆç‚¹èµ

**å›å¤è¯„è®º**ï¼š
- ç‚¹èµæŒ‰é’®ï¼ˆæ˜¾ç¤ºStarFilledå›¾æ ‡å’Œç‚¹èµæ•°ï¼‰
- å·²ç‚¹èµï¼šè“è‰²ï¼ˆprimaryï¼‰æ˜¾ç¤º
- æœªç‚¹èµï¼šé»˜è®¤é¢œè‰²æ˜¾ç¤º
- ç‚¹å‡»ç‚¹èµ/å–æ¶ˆç‚¹èµ

---

## ğŸ”§ åç«¯å®ç°

### 1. æ•°æ®åº“è®¾è®¡

#### t_comment_likeè¡¨ï¼ˆæ–°å»ºï¼‰

```sql
CREATE TABLE IF NOT EXISTS t_comment_like (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ä¸»é”®ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    comment_id BIGINT NOT NULL COMMENT 'è¯„è®ºID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',

    UNIQUE KEY uk_user_comment (user_id, comment_id),
    INDEX idx_user_id (user_id),
    INDEX idx_comment_id (comment_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è¯„è®ºç‚¹èµè¡¨';
```

---

### 2. CommentLikeå®ä½“

```java
@Data
@Entity
@Table(name = "t_comment_like", indexes = {...}, uniqueConstraints = {...})
public class CommentLike {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long userId;
    private Long commentId;
    private LocalDateTime createdAt;
}
```

---

### 3. CommentLikeRepository

```java
public interface CommentLikeRepository extends JpaRepository<CommentLike, Long> {
    Optional<CommentLike> findByUserIdAndCommentId(Long userId, Long commentId);
    boolean existsByUserIdAndCommentId(Long userId, Long commentId);
    void deleteByUserIdAndCommentId(Long userId, Long commentId);
}
```

---

### 4. CommentRepositoryæ›´æ–°

```java
/**
 * æ ¹æ®å°è¯´IDå’Œæ¥¼å±‚åˆ†é¡µæŸ¥è¯¢è¯„è®ºï¼ˆæŒ‰ç‚¹èµæ•°é™åºï¼‰
 */
Page<Comment> findByNovelIdAndFloorAndDeletedOrderByLikeCountDesc(
    Long novelId,
    Integer floor,
    Integer deleted,
    Pageable pageable
);

/**
 * åŸå­æ“ä½œï¼šç‚¹èµæ•°+1
 */
@Modifying
@Query("UPDATE Comment c SET c.likeCount = c.likeCount + 1 WHERE c.id = :commentId")
@Transactional
void incrementLikeCount(@Param("commentId") Long commentId);

/**
 * åŸå­æ“ä½œï¼šç‚¹èµæ•°-1
 */
@Modifying
@Query("UPDATE Comment c SET c.likeCount = c.likeCount - 1 WHERE c.id = :commentId AND c.likeCount > 0")
@Transactional
void decrementLikeCount(@Param("commentId") Long commentId);
```

---

### 5. CommentServiceæ›´æ–°

#### ç‚¹èµè¯„è®º

```java
@Transactional
public Map<String, Object> likeComment(Long userId, Long commentId) {
    // æ£€æŸ¥è¯„è®ºæ˜¯å¦å­˜åœ¨
    // æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
    // åˆ›å»ºç‚¹èµè®°å½•
    // æ›´æ–°è¯„è®ºçš„ç‚¹èµæ•°ï¼ˆåŸå­æ“ä½œï¼‰
    // é‡æ–°è·å–æœ€æ–°çš„ç‚¹èµæ•°
}
```

#### å–æ¶ˆç‚¹èµè¯„è®º

```java
@Transactional
public Map<String, Object> unlikeComment(Long userId, Long commentId) {
    // æ£€æŸ¥è¯„è®ºæ˜¯å¦å­˜åœ¨
    // æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
    // åˆ é™¤ç‚¹èµè®°å½•
    // æ›´æ–°è¯„è®ºçš„ç‚¹èµæ•°ï¼ˆåŸå­æ“ä½œï¼‰
    // é‡æ–°è·å–æœ€æ–°çš„ç‚¹èµæ•°
}
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### ç‚¹èµåŠŸèƒ½æµ‹è¯•

| æµ‹è¯•åœºæ™¯ | æè¿° | çŠ¶æ€ |
|---------|------|------|
| ç‚¹èµè¯„è®º | æˆåŠŸç‚¹èµï¼Œç‚¹èµæ•°+1ï¼Œliked=true | âœ… é€šè¿‡ |
| é‡å¤ç‚¹èµ | å·²ç‚¹èµï¼Œè¿”å›é”™è¯¯ï¼Œç‚¹èµæ•°ä¸å˜ | âœ… é€šè¿‡ |
| å–æ¶ˆç‚¹èµ | æˆåŠŸå–æ¶ˆï¼Œç‚¹èµæ•°-1ï¼Œliked=false | âœ… é€šè¿‡ |
| é‡å¤å–æ¶ˆ | æœªç‚¹èµï¼Œè¿”å›é”™è¯¯ï¼Œç‚¹èµæ•°ä¸å˜ | âœ… é€šè¿‡ |
| è¯„è®ºä¸å­˜åœ¨ | è¯„è®ºä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯ | âœ… é€šè¿‡ |

---

## ğŸ“Š å¼€å‘è¿›åº¦

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ | çŠ¶æ€ |
|------|------|--------|------|
| åç«¯å¼€å‘ | æ•°æ®åº“è¿ç§» | 0.5h | âœ… å·²å®Œæˆ |
| åç«¯å¼€å‘ | CommentLikeå®ä½“å¼€å‘ | 0.5h | âœ… å·²å®Œæˆ |
| åç«¯å¼€å‘ | CommentLikeRepositoryå¼€å‘ | 0.5h | âœ… å·²å®Œæˆ |
| åç«¯å¼€å‘ | CommentRepositoryæ›´æ–° | 0.5h | âœ… å·²å®Œæˆ |
| åç«¯å¼€å‘ | CommentServiceæ›´æ–° | 1h | âœ… å·²å®Œæˆ |
| åç«¯å¼€å‘ | CommentControlleræ›´æ–° | 0.5h | âœ… å·²å®Œæˆ |
| å‰ç«¯å¼€å‘ | APIå’ŒMockæ•°æ®æ›´æ–° | 0.5h | âœ… å·²å®Œæˆ |
| å‰ç«¯å¼€å‘ | NovelDetail.vueç‚¹èµæŒ‰é’® | 0.5h | âœ… å·²å®Œæˆ |
| å‰ç«¯å¼€å‘ | NovelDetail.vueç‚¹èµåŠŸèƒ½ | 0.5h | âœ… å·²å®Œæˆ |

**æ€»è®¡**: çº¦5å°æ—¶

---

## ğŸ¯ Gitæäº¤è®°å½•

| æäº¤ID | æäº¤ä¿¡æ¯ | æ—¶é—´ |
|--------|---------|------|
| 270523e | feat: æ·»åŠ è¯„è®ºç‚¹èµåŠŸèƒ½ | 14:30 |
| af399d6 | feat: å‰ç«¯æ·»åŠ è¯„è®ºç‚¹èµç›¸å…³APIå’ŒMockæ•°æ® | 14:35 |
| bc29529 | feat: å°è¯´è¯¦æƒ…é¡µæ·»åŠ è¯„è®ºç‚¹èµåŠŸèƒ½ | 14:40 |

### GitHubæ¨é€è®°å½•

- **ä»“åº“**: https://github.com/lridea/novel-reader
- **åˆ†æ”¯**: master
- **æœ€æ–°æäº¤**: bc29529

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. åŸå­æ“ä½œè§£å†³å¹¶å‘é—®é¢˜

```java
@Modifying
@Query("UPDATE Comment c SET c.likeCount = c.likeCount + 1 WHERE c.id = :commentId")
@Transactional
void incrementLikeCount(@Param("commentId") Long commentId);
```

**ä¼˜ç‚¹**ï¼š
- åŸå­æ“ä½œï¼Œä¸ä¼šä¸¢å¤±æ›´æ–°
- æ€§èƒ½å¥½ï¼Œä¸éœ€è¦é”
- å®ç°ç®€å•ï¼Œæ— éœ€é¢å¤–å­—æ®µ

---

### 2. å”¯ä¸€ç´¢å¼•é˜²æ­¢é‡å¤ç‚¹èµ

```sql
UNIQUE KEY uk_user_comment (user_id, comment_id)
```

**ä¼˜ç‚¹**ï¼š
- æ•°æ®åº“å±‚é¢é˜²æ­¢é‡å¤ç‚¹èµ
- é¿å…è„æ•°æ®
- è‡ªåŠ¨å¤„ç†å¹¶å‘å†²çª

---

### 3. æŒ‰ç‚¹èµæ•°é™åºå±•ç¤º

```java
Page<Comment> findByNovelIdAndFloorAndDeletedOrderByLikeCountDesc(...);
```

**ä¼˜ç‚¹**ï¼š
- ä¼˜ç§€è¯„è®ºé å‰å±•ç¤º
- æå‡ç”¨æˆ·ä½“éªŒ
- æ¿€åŠ±ç”¨æˆ·å‘å¸ƒä¼˜è´¨è¯„è®º

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [x] ç™»å½•ç”¨æˆ·å¯ä»¥ç‚¹èµè¯„è®º
- [x] ç™»å½•ç”¨æˆ·å¯ä»¥å–æ¶ˆç‚¹èµ
- [x] æœªç™»å½•ç”¨æˆ·ä¸èƒ½ç‚¹èµ
- [x] ç‚¹èµæ•°æ­£ç¡®æ˜¾ç¤º
- [x] ç‚¹èµçŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- [x] è¯„è®ºæŒ‰ç‚¹èµæ•°é™åºå±•ç¤º
- [x] å›å¤æŒ‰æ—¶é—´å‡åºå±•ç¤º
- [x] ç‚¹èµæ•°ä¸ä¼šä¸¢å¤±æ›´æ–°ï¼ˆå¹¶å‘æµ‹è¯•ï¼‰

---

### æ€§èƒ½éªŒæ”¶

- [ ] ç‚¹èµè¯„è®º < 200ms
- [ ] å–æ¶ˆç‚¹èµ < 200ms
- [ ] è·å–è¯„è®ºåˆ—è¡¨ < 100ms

---

### å…¼å®¹æ€§éªŒæ”¶

- [ ] æœªç™»å½•ç”¨æˆ·å¯ä»¥æ­£å¸¸æµè§ˆï¼ˆç‚¹èµæŒ‰é’®ä¸æ˜¾ç¤ºï¼‰
- [ ] ç™»å½•ç”¨æˆ·ç‚¹èµåŠŸèƒ½æ­£å¸¸
- [ ] ç‚¹èµæ•°å¹¶å‘æ›´æ–°æ­£ç¡®

---

## ğŸ“ å¾…åŠäº‹é¡¹

### åŠŸèƒ½å¾…ä¼˜åŒ–

- [ ] ç‚¹èµæ•°ç¼“å­˜ä¼˜åŒ–
- [ ] ç‚¹èµåˆ—è¡¨å±•ç¤ºï¼ˆå¯é€‰ï¼‰
- [ ] ç‚¹èµé€šçŸ¥ï¼ˆå¯é€‰ï¼‰

### æ€§èƒ½ä¼˜åŒ–

- [ ] ç‚¹èµæ•°ç¼“å­˜
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] æ‰¹é‡æŸ¥è¯¢ç‚¹èµçŠ¶æ€

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æƒé™æ§åˆ¶

1. **æœªç™»å½•ç”¨æˆ·**ï¼šä¸èƒ½ç‚¹èµ
2. **å·²ç™»å½•ç”¨æˆ·**ï¼šå¯ä»¥ç‚¹èµ/å–æ¶ˆç‚¹èµ

---

### 2. å¹¶å‘é—®é¢˜

1. âœ… **ç‚¹èµæ•°æ›´æ–°**ï¼šä½¿ç”¨åŸå­æ“ä½œï¼Œé¿å…å¹¶å‘å†²çª
2. âœ… **é‡å¤ç‚¹èµ**ï¼šä½¿ç”¨å”¯ä¸€ç´¢å¼•ï¼Œé˜²æ­¢é‡å¤ç‚¹èµ

---

### 3. æ•°æ®ä¸€è‡´æ€§

1. âœ… **ç‚¹èµæ•°åŒæ­¥**ï¼šç‚¹èµ/å–æ¶ˆç‚¹èµåå®æ—¶æ›´æ–°ç‚¹èµæ•°
2. âœ… **ç‚¹èµçŠ¶æ€åŒæ­¥**ï¼šè¿”å›æ­£ç¡®çš„likedçŠ¶æ€

---

## ğŸ† æ€»ç»“

### å®Œæˆæƒ…å†µ

âœ… **æ ¸å¿ƒåŠŸèƒ½å·²å…¨éƒ¨å®Œæˆ**ï¼š
- ç‚¹èµè¯„è®ºåŠŸèƒ½
- å–æ¶ˆç‚¹èµåŠŸèƒ½
- ç‚¹èµçŠ¶æ€æ˜¾ç¤º
- æŒ‰ç‚¹èµæ•°é™åºå±•ç¤º
- ç‚¹èµæ•°å®æ—¶æ›´æ–°

---

### æŠ€æœ¯äº®ç‚¹

1. âœ… **åŸå­æ“ä½œè§£å†³å¹¶å‘é—®é¢˜**
2. âœ… **å”¯ä¸€ç´¢å¼•é˜²æ­¢é‡å¤ç‚¹èµ**
3. âœ… **æŒ‰ç‚¹èµæ•°é™åºå±•ç¤º**
4. âœ… **å®æ—¶æ›´æ–°ç‚¹èµæ•°**
5. âœ… **å®Œå–„çš„Mockæ•°æ®**

---

### åç»­ä¼˜åŒ–

1. âš ï¸ **æ€§èƒ½ä¼˜åŒ–**ï¼šç‚¹èµæ•°ç¼“å­˜ã€æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
2. âš ï¸ **åŠŸèƒ½æ‰©å±•**ï¼šç‚¹èµåˆ—è¡¨å±•ç¤ºã€ç‚¹èµé€šçŸ¥

---

**å¼€å‘å®Œæˆæ—¶é—´**: 2026-02-18 14:40
**å¼€å‘äººå‘˜**: OpenClaw
**GitHubä»“åº“**: https://github.com/lridea/novel-reader
**æœ€æ–°æäº¤**: bc29529
**å¼€å‘çŠ¶æ€**: âœ… ç‚¹èµåŠŸèƒ½å·²å®Œæˆ

ğŸ¦
