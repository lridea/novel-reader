# è¯»ä¹¦ç½‘ç«™ - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ“Œ è®¾è®¡åŸåˆ™

1. **è§„èŒƒåŒ–è®¾è®¡**ï¼šéµå¾ªç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨ç´¢å¼•ã€å¤–é”®çº¦æŸ
3. **æ‰©å±•æ€§**ï¼šé¢„ç•™å­—æ®µï¼Œä¾¿äºåç»­æ‰©å±•
4. **æ•°æ®å®Œæ•´æ€§**ï¼šä½¿ç”¨çº¦æŸã€è§¦å‘å™¨ä¿è¯æ•°æ®ä¸€è‡´æ€§
5. **è½¯åˆ é™¤**ï¼šé‡è¦æ•°æ®ä½¿ç”¨ `deleted` å­—æ®µæ ‡è®°åˆ é™¤

---

## ğŸ—„ï¸ æ•°æ®åº“æ¦‚è§ˆ

### PostgreSQL æ•°æ®åº“
**æ•°æ®åº“åç§°**ï¼š`novel_reader`

### ä¸»è¦è¡¨ç»“æ„
1. `t_user` - ç”¨æˆ·è¡¨
2. `t_novel` - å°è¯´è¡¨
3. `t_novel_tag` - å°è¯´æ ‡ç­¾å…³è”è¡¨
4. `t_chapter` - ç« èŠ‚è¡¨
5. `t_favorite` - æ”¶è—è¡¨
6. `t_category` - æ”¶è—åˆ†ç±»è¡¨
7. `t_favorite_category` - æ”¶è—ä¸åˆ†ç±»å…³è”è¡¨
8. `t_update_log` - æ›´æ–°æ—¥å¿—è¡¨
9. `t_crawler_task` - çˆ¬è™«ä»»åŠ¡è¡¨

---

## ğŸ“‹ è¡¨ç»“æ„è¯¦è§£

### 1. ç”¨æˆ·è¡¨ (t_user)

```sql
CREATE TABLE t_user (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    nickname VARCHAR(50),
    avatar_url VARCHAR(500),
    status TINYINT DEFAULT 1 COMMENT '0-ç¦ç”¨, 1-æ­£å¸¸',
    deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_user_email ON t_user(email);
CREATE INDEX idx_user_username ON t_user(username);
CREATE INDEX idx_user_status ON t_user(status);
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| id | BIGSERIAL | ä¸»é”® | âœ… |
| username | VARCHAR(50) | ç”¨æˆ·å | âœ… |
| email | VARCHAR(100) | é‚®ç®± | âœ… |
| password | VARCHAR(255) | å¯†ç ï¼ˆBCryptåŠ å¯†ï¼‰ | âœ… |
| nickname | VARCHAR(50) | æ˜µç§° | âŒ |
| avatar_url | VARCHAR(500) | å¤´åƒURL | âŒ |
| status | TINYINT | çŠ¶æ€ï¼ˆ0-ç¦ç”¨, 1-æ­£å¸¸ï¼‰ | âœ… |
| deleted | BOOLEAN | æ˜¯å¦åˆ é™¤ | âœ… |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | âœ… |

---

### 2. å°è¯´è¡¨ (t_novel)

```sql
CREATE TABLE t_novel (
    id BIGSERIAL PRIMARY KEY,
    platform VARCHAR(50) NOT NULL COMMENT 'å¹³å°æ¥æº',
    novel_id VARCHAR(100) NOT NULL COMMENT 'å¹³å°å†…å”¯ä¸€ID',
    title VARCHAR(200) NOT NULL,
    author VARCHAR(100),
    description TEXT,
    cover_url VARCHAR(500),
    latest_chapter_title VARCHAR(200),
    latest_update_time TIMESTAMP,
    last_crawl_time TIMESTAMP,
    crawl_count INT DEFAULT 0,
    status TINYINT DEFAULT 1 COMMENT '0-åœæ›´, 1-è¿è½½, 2-å®Œç»“',
    deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(platform, novel_id)
);

-- ç´¢å¼•
CREATE INDEX idx_novel_platform ON t_novel(platform);
CREATE INDEX idx_novel_title ON t_novel(title);
CREATE INDEX idx_novel_author ON t_novel(author);
CREATE INDEX idx_novel_update_time ON t_novel(latest_update_time DESC);
CREATE INDEX idx_novel_status ON t_novel(status);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_novel_title_search ON t_novel USING gin(to_tsvector('chinese', title));
CREATE INDEX idx_novel_author_search ON t_novel USING gin(to_tsvector('chinese', author));
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| id | BIGSERIAL | ä¸»é”® | âœ… |
| platform | VARCHAR(50) | å¹³å°æ¥æºï¼ˆciweimao/sf/ciyuanji/qidianï¼‰ | âœ… |
| novel_id | VARCHAR(100) | å¹³å°å†…å”¯ä¸€ID | âœ… |
| title | VARCHAR(200) | ä¹¦å | âœ… |
| author | VARCHAR(100) | ä½œè€… | âŒ |
| description | TEXT | ç®€ä»‹ | âŒ |
| cover_url | VARCHAR(500) | å°é¢URL | âŒ |
| latest_chapter_title | VARCHAR(200) | æœ€æ–°ç« èŠ‚æ ‡é¢˜ | âŒ |
| latest_update_time | TIMESTAMP | æœ€æ–°æ›´æ–°æ—¶é—´ | âŒ |
| last_crawl_time | TIMESTAMP | æœ€åæŠ“å–æ—¶é—´ | âŒ |
| crawl_count | INT | æŠ“å–æ¬¡æ•° | âœ… |
| status | TINYINT | çŠ¶æ€ï¼ˆ0-åœæ›´, 1-è¿è½½, 2-å®Œç»“ï¼‰ | âœ… |
| deleted | BOOLEAN | æ˜¯å¦åˆ é™¤ | âœ… |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | âœ… |

**å”¯ä¸€çº¦æŸ**ï¼š(platform, novel_id)

---

### 3. å°è¯´æ ‡ç­¾å…³è”è¡¨ (t_novel_tag)

```sql
CREATE TABLE t_novel_tag (
    id BIGSERIAL PRIMARY KEY,
    novel_id BIGINT NOT NULL REFERENCES t_novel(id) ON DELETE CASCADE,
    tag_name VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_tag_novel_id ON t_novel_tag(novel_id);
CREATE INDEX idx_tag_name ON t_novel_tag(tag_name);
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| id | BIGSERIAL | ä¸»é”® | âœ… |
| novel_id | BIGINT | å°è¯´IDï¼ˆå¤–é”®ï¼‰ | âœ… |
| tag_name | VARCHAR(50) | æ ‡ç­¾å | âœ… |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… |

**å¤–é”®**ï¼šnovel_id â†’ t_novel(id) ON DELETE CASCADE

---

### 4. ç« èŠ‚è¡¨ (t_chapter)

```sql
CREATE TABLE t_chapter (
    id BIGSERIAL PRIMARY KEY,
    novel_id BIGINT NOT NULL REFERENCES t_novel(id) ON DELETE CASCADE,
    chapter_id VARCHAR(100) NOT NULL,
    chapter_title VARCHAR(200) NOT NULL,
    chapter_content TEXT,
    ai_summary TEXT COMMENT 'AIç”Ÿæˆçš„æ¦‚æ‹¬',
    is_latest BOOLEAN DEFAULT FALSE,
    chapter_order INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(novel_id, chapter_id)
);

-- ç´¢å¼•
CREATE INDEX idx_chapter_novel_id ON t_chapter(novel_id);
CREATE INDEX idx_chapter_order ON t_chapter(novel_id, chapter_order);
CREATE INDEX idx_chapter_is_latest ON t_chapter(is_latest);
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| id | BIGSERIAL | ä¸»é”® | âœ… |
| novel_id | BIGINT | å°è¯´IDï¼ˆå¤–é”®ï¼‰ | âœ… |
| chapter_id | VARCHAR(100) | ç« èŠ‚ID | âœ… |
| chapter_title | VARCHAR(200) | ç« èŠ‚æ ‡é¢˜ | âœ… |
| chapter_content | TEXT | ç« èŠ‚å†…å®¹ | âŒ |
| ai_summary | TEXT | AIæ¦‚æ‹¬ | âŒ |
| is_latest | BOOLEAN | æ˜¯å¦æœ€æ–°ç« èŠ‚ | âœ… |
| chapter_order | INT | ç« èŠ‚åºå· | âŒ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | âœ… |

**å”¯ä¸€çº¦æŸ**ï¼š(novel_id, chapter_id)
**å¤–é”®**ï¼šnovel_id â†’ t_novel(id) ON DELETE CASCADE

**è¯´æ˜**ï¼š
- é¦–æ¬¡æŠ“å–æ—¶å­˜å‚¨å‰3-5ç« 
- AIæ¦‚æ‹¬åªåœ¨é¦–æ¬¡æŠ“å–æ—¶ç”Ÿæˆ
- is_latest æ ‡è®°å½“å‰æœ€æ–°ç« èŠ‚

---

### 5. æ”¶è—è¡¨ (t_favorite)

```sql
CREATE TABLE t_favorite (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES t_user(id) ON DELETE CASCADE,
    novel_id BIGINT NOT NULL REFERENCES t_novel(id) ON DELETE CASCADE,
    note VARCHAR(500) COMMENT 'å¤‡æ³¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, novel_id)
);

-- ç´¢å¼•
CREATE INDEX idx_favorite_user_id ON t_favorite(user_id);
CREATE INDEX idx_favorite_novel_id ON t_favorite(novel_id);
CREATE INDEX idx_favorite_created_at ON t_favorite(user_id, created_at DESC);
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| id | BIGSERIAL | ä¸»é”® | âœ… |
| user_id | BIGINT | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ | âœ… |
| novel_id | BIGINT | å°è¯´IDï¼ˆå¤–é”®ï¼‰ | âœ… |
| note | VARCHAR(500) | å¤‡æ³¨ | âŒ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | âœ… |

**å”¯ä¸€çº¦æŸ**ï¼š(user_id, novel_id)
**å¤–é”®**ï¼šuser_id â†’ t_user(id) ON DELETE CASCADE
**å¤–é”®**ï¼šnovel_id â†’ t_novel(id) ON DELETE CASCADE

---

### 6. æ”¶è—åˆ†ç±»è¡¨ (t_category)

```sql
CREATE TABLE t_category (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES t_user(id) ON DELETE CASCADE,
    name VARCHAR(50) NOT NULL,
    description VARCHAR(200),
    sort_order INT DEFAULT 0,
    deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_category_user_id ON t_category(user_id);
CREATE INDEX idx_category_sort_order ON t_category(user_id, sort_order);
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| id | BIGSERIAL | ä¸»é”® | âœ… |
| user_id | BIGINT | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ | âœ… |
| name | VARCHAR(50) | åˆ†ç±»åç§° | âœ… |
| description | VARCHAR(200) | æè¿° | âŒ |
| sort_order | INT | æ’åºåºå· | âœ… |
| deleted | BOOLEAN | æ˜¯å¦åˆ é™¤ | âœ… |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | âœ… |

**å¤–é”®**ï¼šuser_id â†’ t_user(id) ON DELETE CASCADE

---

### 7. æ”¶è—ä¸åˆ†ç±»å…³è”è¡¨ (t_favorite_category)

```sql
CREATE TABLE t_favorite_category (
    id BIGSERIAL PRIMARY KEY,
    favorite_id BIGINT NOT NULL REFERENCES t_favorite(id) ON DELETE CASCADE,
    category_id BIGINT NOT NULL REFERENCES t_category(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(favorite_id, category_id)
);

-- ç´¢å¼•
CREATE INDEX idx_fc_favorite_id ON t_favorite_category(favorite_id);
CREATE INDEX idx_fc_category_id ON t_favorite_category(category_id);
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| id | BIGSERIAL | ä¸»é”® | âœ… |
| favorite_id | BIGINT | æ”¶è—IDï¼ˆå¤–é”®ï¼‰ | âœ… |
| category_id | BIGINT | åˆ†ç±»IDï¼ˆå¤–é”®ï¼‰ | âœ… |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… |

**å”¯ä¸€çº¦æŸ**ï¼š(favorite_id, category_id)
**å¤–é”®**ï¼šfavorite_id â†’ t_favorite(id) ON DELETE CASCADE
**å¤–é”®**ï¼šcategory_id â†’ t_category(id) ON DELETE CASCADE

**è¯´æ˜**ï¼šä¸€ä¸ªæ”¶è—å¯ä»¥å±äºå¤šä¸ªåˆ†ç±»

---

### 8. æ›´æ–°æ—¥å¿—è¡¨ (t_update_log)

```sql
CREATE TABLE t_update_log (
    id BIGSERIAL PRIMARY KEY,
    novel_id BIGINT NOT NULL REFERENCES t_novel(id) ON DELETE CASCADE,
    chapter_title VARCHAR(200),
    update_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_update_log_novel_id ON t_update_log(novel_id);
CREATE INDEX idx_update_log_time ON t_update_log(update_time DESC);
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| id | BIGSERIAL | ä¸»é”® | âœ… |
| novel_id | BIGINT | å°è¯´IDï¼ˆå¤–é”®ï¼‰ | âœ… |
| chapter_title | VARCHAR(200) | æ›´æ–°ç« èŠ‚æ ‡é¢˜ | âŒ |
| update_time | TIMESTAMP | æ›´æ–°æ—¶é—´ | âŒ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… |

**å¤–é”®**ï¼šnovel_id â†’ t_novel(id) ON DELETE CASCADE

**è¯´æ˜**ï¼šè®°å½•å°è¯´æ›´æ–°å†å²ï¼Œç”¨äºæŸ¥çœ‹æ›´æ–°è¶‹åŠ¿

---

### 9. çˆ¬è™«ä»»åŠ¡è¡¨ (t_crawler_task)

```sql
CREATE TABLE t_crawler_task (
    id BIGSERIAL PRIMARY KEY,
    platform VARCHAR(50) NOT NULL,
    task_name VARCHAR(100) NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING' COMMENT 'PENDING/RUNNING/SUCCESS/FAILED',
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    total_count INT DEFAULT 0,
    success_count INT DEFAULT 0,
    failed_count INT DEFAULT 0,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_crawler_platform ON t_crawler_task(platform);
CREATE INDEX idx_crawler_status ON t_crawler_task(status);
CREATE INDEX idx_crawler_created_at ON t_crawler_task(created_at DESC);
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…å¡« |
|------|------|------|------|
| id | BIGSERIAL | ä¸»é”® | âœ… |
| platform | VARCHAR(50) | å¹³å°åç§° | âœ… |
| task_name | VARCHAR(100) | ä»»åŠ¡åç§° | âœ… |
| status | VARCHAR(20) | çŠ¶æ€ | âœ… |
| start_time | TIMESTAMP | å¼€å§‹æ—¶é—´ | âŒ |
| end_time | TIMESTAMP | ç»“æŸæ—¶é—´ | âŒ |
| total_count | INT | æ€»æ•° | âœ… |
| success_count | INT | æˆåŠŸæ•° | âœ… |
| failed_count | INT | å¤±è´¥æ•° | âœ… |
| error_message | TEXT | é”™è¯¯ä¿¡æ¯ | âŒ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | âœ… |

**è¯´æ˜**ï¼šè®°å½•æ¯æ¬¡çˆ¬è™«ä»»åŠ¡æ‰§è¡Œæƒ…å†µ

---

## ğŸ”— ER å›¾

```
t_user (ç”¨æˆ·)
  â”œâ”€ t_category (æ”¶è—åˆ†ç±») [1:N]
  â”œâ”€ t_favorite (æ”¶è—) [1:N]
  â”‚     â”œâ”€ t_favorite_category (æ”¶è—åˆ†ç±»å…³è”) [N:N]
  â”‚
t_novel (å°è¯´)
  â”œâ”€ t_novel_tag (æ ‡ç­¾) [1:N]
  â”œâ”€ t_chapter (ç« èŠ‚) [1:N]
  â”œâ”€ t_update_log (æ›´æ–°æ—¥å¿—) [1:N]
  â””â”€ t_favorite (æ”¶è—) [1:N]

t_crawler_task (çˆ¬è™«ä»»åŠ¡) [ç‹¬ç«‹]
```

---

## ğŸ“Š ç´¢å¼•ç­–ç•¥

### 1. æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•
- å°è¯´åˆ—è¡¨ï¼š`idx_novel_update_time`ï¼ˆæœ€æ–°æ›´æ–°ï¼‰
- æœç´¢åŠŸèƒ½ï¼šå…¨æ–‡æœç´¢ç´¢å¼• `to_tsvector`
- ç”¨æˆ·æ”¶è—ï¼š`idx_favorite_user_id` + `idx_favorite_created_at`

### 2. å”¯ä¸€ç´¢å¼•
- é˜²æ­¢é‡å¤ï¼š`(platform, novel_id)`ã€`(user_id, novel_id)`

### 3. å¤–é”®ç´¢å¼•
- æ‰€æœ‰å¤–é”®å­—æ®µè‡ªåŠ¨åˆ›å»ºç´¢å¼•

---

## ğŸ’¾ æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### Docker åˆå§‹åŒ–
```sql
-- æ•°æ®åº“åˆ›å»º
CREATE DATABASE novel_reader;

-- åˆ‡æ¢æ•°æ®åº“
\c novel_reader;

-- æ‰§è¡Œä¸Šè¿°å»ºè¡¨è¯­å¥

-- æ’å…¥åˆå§‹æ•°æ®
INSERT INTO t_user (username, email, password, nickname)
VALUES ('admin', 'admin@example.com', '$2a$10$...', 'ç®¡ç†å‘˜');
```

---

## ğŸ§ª æ•°æ®æµ‹è¯•

### æµ‹è¯•æ•°æ®é‡
- ç”¨æˆ·ï¼š100æ¡
- å°è¯´ï¼š1000æ¡
- æ ‡ç­¾ï¼š5000æ¡
- ç« èŠ‚ï¼š3000æ¡
- æ”¶è—ï¼š500æ¡

---

## ğŸ“ ä¸‹ä¸€æ­¥

æ•°æ®åº“è®¾è®¡å·²å®Œæˆï¼Œä¸‹ä¸€æ­¥å°†è¿›è¡Œï¼š
1. åç«¯APIæ¥å£è®¾è®¡
2. å‰ç«¯é¡µé¢è®¾è®¡
3. ç³»ç»Ÿæ¶æ„è®¾è®¡
