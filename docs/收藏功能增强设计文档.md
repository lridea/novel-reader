# æ”¶è—åŠŸèƒ½å¢å¼ºè®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**è®¾è®¡æ—¥æœŸ**: 2026-02-18
**è®¾è®¡äººå‘˜**: OpenClaw
**çŠ¶æ€**: å¾…è¯„å®¡

---

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### åŠŸèƒ½éœ€æ±‚

| åºå· | åŠŸèƒ½ | æè¿° | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|------|--------|------|
| 1 | å±•ç¤ºæ”¶è—çŠ¶æ€ | åœ¨ä¹¦ç±åˆ—è¡¨å’Œè¯¦æƒ…é¡µä¸­å±•ç¤ºæ˜¯å¦è¢«æ”¶è—ï¼ˆç™»å½•åå±•ç¤ºï¼‰ | P0 | å¾…å¼€å‘ |
| 2 | å±•ç¤ºæ”¶è—æ•° | åœ¨åˆ—è¡¨å’Œè¯¦æƒ…é¡µå±•ç¤ºæ”¶è—æ•°ï¼ˆä¸éœ€è¦ç™»å½•ï¼‰ | P0 | å¾…å¼€å‘ |
| 3 | æŒ‰æ”¶è—æ•°è¿‡æ»¤ | åˆ—è¡¨å¢åŠ æŒ‰æ”¶è—æ•°è¿‡æ»¤åŠŸèƒ½ | P0 | å¾…å¼€å‘ |
| 4 | æŒ‰æ”¶è—æ•°æ’åº | åˆ—è¡¨å¢åŠ æŒ‰æ”¶è—æ•°é™åºæ’åºåŠŸèƒ½ | P0 | å¾…å¼€å‘ |

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. ä¿®æ”¹ t_novel è¡¨

**æ–°å¢å­—æ®µ**ï¼š

```sql
-- æ·»åŠ æ”¶è—æ•°å­—æ®µ
ALTER TABLE t_novel ADD COLUMN favorite_count INT DEFAULT 0 COMMENT 'æ”¶è—æ•°' AFTER word_count;

-- æ·»åŠ æ”¶è—æ•°å­—æ®µç´¢å¼•
CREATE INDEX idx_favorite_count ON t_novel(favorite_count);
```

**å­—æ®µè¯´æ˜**ï¼š
- `favorite_count`: æ”¶è—æ•°ï¼Œé»˜è®¤0

### 2. t_user_favorite è¡¨ï¼ˆå·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰

å½“å‰è¡¨ç»“æ„ï¼š
```sql
CREATE TABLE IF NOT EXISTS t_user_favorite (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ä¸»é”®ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    novel_id BIGINT NOT NULL COMMENT 'å°è¯´ID',
    category VARCHAR(50) DEFAULT 'default' COMMENT 'åˆ†ç±»åç§°',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    UNIQUE KEY uk_user_novel (user_id, novel_id),
    INDEX idx_user_id (user_id),
    INDEX idx_novel_id (novel_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·æ”¶è—è¡¨';
```

---

## ğŸŒ APIæ¥å£è®¾è®¡

### 1. ä¿®æ”¹å°è¯´åˆ—è¡¨æ¥å£ï¼ˆå·²å­˜åœ¨ï¼Œéœ€è¦æ‰©å±•ï¼‰

**æ¥å£è·¯å¾„**: `GET /api/crawler/novels/page`

**æ‰©å±•å‚æ•°**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| favoriteCountMin | Integer | å¦ | null | æœ€å°æ”¶è—æ•° |
| favoriteCountMax | Integer | å¦ | null | æœ€å¤§æ”¶è—æ•° |
| sortBy | String | å¦ | updateTime | æ’åºå­—æ®µï¼ˆæ–°å¢favoriteCountï¼‰ |
| sortOrder | String | å¦ | desc | æ’åºæ–¹å‘ï¼ˆasc/descï¼‰ |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

ç¤ºä¾‹1ï¼šæŒ‰æ”¶è—æ•°é™åºæ’åº
```
GET /api/crawler/novels/page?sortBy=favoriteCount&sortOrder=desc
```

ç¤ºä¾‹2ï¼šç­›é€‰æ”¶è—æ•°å¤§äºç­‰äº10çš„å°è¯´
```
GET /api/crawler/novels/page?favoriteCountMin=10
```

ç¤ºä¾‹3ï¼šç­›é€‰æ”¶è—æ•°åœ¨10-100ä¹‹é—´çš„å°è¯´
```
GET /api/crawler/novels/page?favoriteCountMin=10&favoriteCountMax=100
```

**å“åº”æ ¼å¼**ï¼ˆæ–°å¢å­—æ®µï¼‰ï¼š

```json
{
  "content": [
    {
      "id": 1,
      "title": "ä¿®ä»™ä»ç³»ç»Ÿå¼€å§‹",
      "author": "å¼ ä¸‰",
      "platform": "ciweimao",
      "coverUrl": "https://example.com/cover.jpg",
      "latestChapterTitle": "ç¬¬100ç«  å¤§ç»“å±€",
      "tags": "[\"ç„å¹»\", \"ä¿®ä»™\"]",
      "wordCount": 1000000,
      "favoriteCount": 125,  // æ–°å¢å­—æ®µï¼šæ”¶è—æ•°
      "isFavorite": false,     // æ–°å¢å­—æ®µï¼šæ˜¯å¦è¢«å½“å‰ç”¨æˆ·æ”¶è—ï¼ˆç™»å½•åè¿”å›ï¼Œæœªç™»å½•è¿”å›nullï¼‰
      "latestUpdateTime": "2026-02-18T10:00:00",
      "status": 1,
      "deleted": 0,
      "createdAt": "2026-02-15T10:00:00",
      "updatedAt": "2026-02-18T10:00:00"
    }
  ],
  "totalElements": 100,
  "totalPages": 10,
  "size": 10,
  "number": 0
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `favoriteCount`: æ”¶è—æ•°ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è§
- `isFavorite`: æ˜¯å¦è¢«å½“å‰ç”¨æˆ·æ”¶è—ï¼ˆå¸ƒå°”å€¼ï¼‰
  - å·²ç™»å½•ï¼šè¿”å› true/false
  - æœªç™»å½•ï¼šè¿”å› null

---

### 2. æ–°å¢ï¼šæ‰¹é‡æŸ¥è¯¢æ”¶è—çŠ¶æ€æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/favorites/check-batch`

**æŸ¥è¯¢å‚æ•°**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| novelIds | String | æ˜¯ | å°è¯´IDåˆ—è¡¨ï¼Œé€—å·åˆ†éš”ï¼Œå¦‚: "1,2,3" |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```
GET /api/favorites/check-batch?novelIds=1,2,3,4,5
```

**å“åº”æ ¼å¼**ï¼š

```json
{
  "success": true,
  "favorites": {
    "1": true,   // å°è¯´ID:1å·²è¢«æ”¶è—
    "2": false,  // å°è¯´ID:2æœªè¢«æ”¶è—
    "3": true,   // å°è¯´ID:3å·²è¢«æ”¶è—
    "4": false,  // å°è¯´ID:4æœªè¢«æ”¶è—
    "5": false   // å°è¯´ID:5æœªè¢«æ”¶è—
  }
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- å°è¯´åˆ—è¡¨é¡µé¢æ‰¹é‡æŸ¥è¯¢å½“å‰é¡µæ‰€æœ‰å°è¯´çš„æ”¶è—çŠ¶æ€
- é¿å…æ¯ä¸ªå°è¯´å•ç‹¬è¯·æ±‚ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚

---

### 3. ä¿®æ”¹ï¼šæ”¶è—æ¥å£ï¼ˆå·²å­˜åœ¨ï¼Œéœ€è¦åŒæ­¥æ›´æ–°favorite_countï¼‰

**æ¥å£è·¯å¾„**: `POST /api/favorites`

**è¯·æ±‚ä½“**ï¼š

```json
{
  "novelId": 1,
  "category": "default"
}
```

**å“åº”æ ¼å¼**ï¼š

```json
{
  "success": true,
  "message": "æ”¶è—æˆåŠŸ",
  "favorite": {
    "id": 1,
    "userId": 1,
    "novelId": 1,
    "category": "default",
    "createdAt": "2026-02-18T12:00:00"
  },
  "novelFavoriteCount": 126  // æ–°å¢ï¼šå½“å‰å°è¯´çš„æœ€æ–°æ”¶è—æ•°
}
```

**åç«¯é€»è¾‘**ï¼š
1. æ’å…¥æ”¶è—è®°å½•åˆ° `t_user_favorite` è¡¨
2. æ›´æ–° `t_novel` è¡¨çš„ `favorite_count` å­—æ®µï¼ˆ+1ï¼‰
3. è¿”å›æœ€æ–°çš„æ”¶è—æ•°

---

### 4. ä¿®æ”¹ï¼šå–æ¶ˆæ”¶è—æ¥å£ï¼ˆå·²å­˜åœ¨ï¼Œéœ€è¦åŒæ­¥æ›´æ–°favorite_countï¼‰

**æ¥å£è·¯å¾„**: `DELETE /api/favorites/{novelId}`

**è·¯å¾„å‚æ•°**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| novelId | Long | æ˜¯ | å°è¯´ID |

**å“åº”æ ¼å¼**ï¼š

```json
{
  "success": true,
  "message": "å–æ¶ˆæ”¶è—æˆåŠŸ",
  "novelFavoriteCount": 124  // æ–°å¢ï¼šå½“å‰å°è¯´çš„æœ€æ–°æ”¶è—æ•°
}
```

**åç«¯é€»è¾‘**ï¼š
1. ä» `t_user_favorite` è¡¨åˆ é™¤æ”¶è—è®°å½•
2. æ›´æ–° `t_novel` è¡¨çš„ `favorite_count` å­—æ®µï¼ˆ-1ï¼‰
3. è¿”å›æœ€æ–°çš„æ”¶è—æ•°

---

## ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

### 1. å°è¯´åˆ—è¡¨é¡µé¢ï¼ˆNovels.vueï¼‰

#### 1.1 æ”¶è—æ•°å±•ç¤º

åœ¨è¡¨æ ¼ä¸­æ–°å¢"æ”¶è—æ•°"åˆ—ï¼š

```vue
<el-table-column prop="favoriteCount" label="æ”¶è—æ•°" width="100" sortable>
  <template #default="{ row }">
    <span style="color: #F56C6C; font-weight: 500;">
      <el-icon><Star /></el-icon>
      {{ row.favoriteCount || 0 }}
    </span>
  </template>
</el-table-column>
```

**å±•ç¤ºæ•ˆæœ**ï¼š
- æ”¶è—æ•°ç”¨çº¢è‰²ï¼ˆ#F56C6Cï¼‰æ˜¾ç¤ºï¼Œå¸¦æ˜Ÿæ ‡å›¾æ ‡
- æœªç™»å½•æ—¶ä¹Ÿæ˜¾ç¤ºï¼Œæ‰€æœ‰ç”¨æˆ·å¯è§

---

#### 1.2 æ”¶è—çŠ¶æ€å±•ç¤ºï¼ˆç™»å½•åï¼‰

åœ¨"æ“ä½œ"åˆ—ä¸­æ–°å¢æ”¶è—æŒ‰é’®ï¼š

```vue
<el-table-column label="æ“ä½œ" width="120" fixed="right">
  <template #default="{ row }">
    <el-button
      v-if="isLoggedIn && row.isFavorite !== null"
      :type="row.isFavorite ? 'warning' : 'default'"
      :icon="row.isFavorite ? StarFilled : Star"
      size="small"
      @click="toggleFavorite(row)"
    >
      {{ row.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—' }}
    </el-button>
    <el-button type="primary" size="small" @click="viewDetail(row)">
      è¯¦æƒ…
    </el-button>
  </template>
</el-table-column>
```

**å±•ç¤ºæ•ˆæœ**ï¼š
- æœªç™»å½•ï¼šä¸æ˜¾ç¤ºæ”¶è—æŒ‰é’®
- å·²ç™»å½•ä¸”æœªæ”¶è—ï¼šæ˜¾ç¤º"æ”¶è—"æŒ‰é’®ï¼ˆç©ºå¿ƒæ˜Ÿæ ‡ï¼‰
- å·²ç™»å½•ä¸”å·²æ”¶è—ï¼šæ˜¾ç¤º"å·²æ”¶è—"æŒ‰é’®ï¼ˆå®å¿ƒæ˜Ÿæ ‡ï¼Œæ©™è‰²ï¼‰

---

#### 1.3 æŒ‰æ”¶è—æ•°è¿‡æ»¤

åœ¨ç­›é€‰æ¡ä»¶åŒºåŸŸæ–°å¢"æ”¶è—æ•°ç­›é€‰"ï¼š

```vue
<div class="filter-row">
  <span class="filter-label">æ”¶è—æ•°:</span>
  <div class="filter-buttons">
    <el-button
      v-for="fc in favoriteCountOptions"
      :key="fc.value"
      :type="favoriteCountMin === fc.value ? 'primary' : ''"
      :class="{ 'filter-button': true, 'active': favoriteCountMin === fc.value }"
      @click="favoriteCountMin = fc.value; loadData()"
      size="small"
    >
      {{ fc.label }}
    </el-button>
  </div>
</div>
```

**æ”¶è—æ•°ç­›é€‰é€‰é¡¹**ï¼š
```javascript
const favoriteCountOptions = [
  { label: 'å…¨éƒ¨', value: '' },
  { label: '10+', value: 10 },
  { label: '50+', value: 50 },
  { label: '100+', value: 100 },
  { label: '500+', value: 500 },
  { label: '1000+', value: 1000 }
]
```

**å±•ç¤ºæ•ˆæœ**ï¼š
```
æ”¶è—æ•°: [å…¨éƒ¨] [10+] [50+] [100+] [500+] [1000+]
```

---

#### 1.4 æŒ‰æ”¶è—æ•°æ’åº

åœ¨æ’åºé€‰é¡¹ä¸­æ–°å¢"æ”¶è—æ•°é™åº"ï¼š

```javascript
const sortOptions = [
  { label: 'æ›´æ–°æ—¶é—´â†“', value: 'updateTime-desc', sortBy: 'updateTime', sortOrder: 'desc' },
  { label: 'æ›´æ–°æ—¶é—´â†‘', value: 'updateTime-asc', sortBy: 'updateTime', sortOrder: 'asc' },
  { label: 'å­—æ•°â†“', value: 'wordCount-desc', sortBy: 'wordCount', sortOrder: 'desc' },
  { label: 'å­—æ•°â†‘', value: 'wordCount-asc', sortBy: 'wordCount', sortOrder: 'asc' },
  { label: 'æ”¶è—æ•°â†“', value: 'favoriteCount-desc', sortBy: 'favoriteCount', sortOrder: 'desc' },  // æ–°å¢
  { label: 'æ”¶è—æ•°â†‘', value: 'favoriteCount-asc', sortBy: 'favoriteCount', sortOrder: 'asc' }   // æ–°å¢
]
```

**å±•ç¤ºæ•ˆæœ**ï¼š
```
æ’åº: [æ›´æ–°æ—¶é—´â†“] [æ›´æ–°æ—¶é—´â†‘] [å­—æ•°â†“] [å­—æ•°â†‘] [æ”¶è—æ•°â†“] [æ”¶è—æ•°â†‘]
```

---

### 2. å°è¯´è¯¦æƒ…é¡µé¢ï¼ˆNovelDetail.vueï¼‰

#### 2.1 æ”¶è—æ•°å±•ç¤º

åœ¨å°è¯´ä¿¡æ¯ä¸­æ–°å¢æ”¶è—æ•°å±•ç¤ºï¼š

```vue
<div class="meta-info">
  <el-tag>{{ getPlatformName(novel.platform) }}</el-tag>
  <span class="author">ä½œè€…ï¼š{{ novel.author || 'æœªçŸ¥' }}</span>
  <el-tag :type="getStatusType(novel.status)">
    {{ getStatusText(novel.status) }}
  </el-tag>
  <span class="favorite-count">
    <el-icon><Star /></el-icon>
    {{ novel.favoriteCount || 0 }}
  </span>
</div>
```

**å±•ç¤ºæ•ˆæœ**ï¼š
- æ”¶è—æ•°ç”¨çº¢è‰²æ˜¾ç¤ºï¼Œå¸¦æ˜Ÿæ ‡å›¾æ ‡
- æœªç™»å½•æ—¶ä¹Ÿæ˜¾ç¤ºï¼Œæ‰€æœ‰ç”¨æˆ·å¯è§

---

#### 2.2 æ”¶è—æŒ‰é’®ï¼ˆç™»å½•åï¼‰

åœ¨å°è¯´è¯¦æƒ…é¡µé¢é¡¶éƒ¨æ–°å¢æ”¶è—æŒ‰é’®ï¼š

```vue
<el-page-header @back="goBack" title="è¿”å›">
  <template #content>
    <span class="page-title">å°è¯´è¯¦æƒ…</span>
  </template>
  <template #extra>
    <el-button
      v-if="isLoggedIn && novel.isFavorite !== null"
      :type="novel.isFavorite ? 'warning' : 'default'"
      :icon="novel.isFavorite ? StarFilled : Star"
      @click="toggleFavorite(novel)"
    >
      {{ novel.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—' }}
    </el-button>
  </template>
</el-page-header>
```

**å±•ç¤ºæ•ˆæœ**ï¼š
- æœªç™»å½•ï¼šä¸æ˜¾ç¤ºæ”¶è—æŒ‰é’®
- å·²ç™»å½•ä¸”æœªæ”¶è—ï¼šæ˜¾ç¤º"æ”¶è—"æŒ‰é’®ï¼ˆç©ºå¿ƒæ˜Ÿæ ‡ï¼‰
- å·²ç™»å½•ä¸”å·²æ”¶è—ï¼šæ˜¾ç¤º"å·²æ”¶è—"æŒ‰é’®ï¼ˆå®å¿ƒæ˜Ÿæ ‡ï¼Œæ©™è‰²ï¼‰

---

## ğŸ”§ åç«¯å®ç°ç»†èŠ‚

### 1. Novelå®ä½“æ›´æ–°

```java
@Data
@Entity
@Table(name = "t_novel", indexes = {
    @Index(name = "idx_platform", columnList = "platform"),
    @Index(name = "idx_title", columnList = "title"),
    @Index(name = "idx_author", columnList = "author"),
    @Index(name = "idx_update_time", columnList = "latestUpdateTime"),
    @Index(name = "idx_status", columnList = "status"),
    @Index(name = "idx_favorite_count", columnList = "favoriteCount")  // æ–°å¢
}, uniqueConstraints = {
    @UniqueConstraint(name = "uk_platform_novel", columnNames = {"platform", "novelId"})
})
public class Novel {
    // ... ç°æœ‰å­—æ®µ ...
    
    /**
     * æ”¶è—æ•°
     */
    @ColumnDefault("0")
    private Integer favoriteCount = 0;
    
    /**
     * æ˜¯å¦è¢«å½“å‰ç”¨æˆ·æ”¶è—ï¼ˆDTOå­—æ®µï¼Œä¸å­˜å‚¨åˆ°æ•°æ®åº“ï¼‰
     */
    @Transient
    private Boolean isFavorite;
}
```

---

### 2. NovelRepositoryæ›´æ–°

```java
@Query("SELECT n FROM Novel n WHERE n.deleted = 0 " +
       "AND (:platform IS NULL OR n.platform = :platform) " +
       "AND (:keyword IS NULL OR n.title LIKE %:keyword% OR n.author LIKE %:keyword%) " +
       "AND (:status IS NULL OR n.status = :status) " +
       "AND (:tag IS NULL OR n.tags LIKE %:tag%) " +
       "AND (:wordCountMin IS NULL OR n.wordCount >= :wordCountMin) " +
       "AND (:wordCountMax IS NULL OR n.wordCount <= :wordCountMax) " +
       "AND (:favoriteCountMin IS NULL OR n.favoriteCount >= :favoriteCountMin) " +
       "AND (:favoriteCountMax IS NULL OR n.favoriteCount <= :favoriteCountMax)")
Page<Novel> searchNovels(
    @Param("platform") String platform,
    @Param("keyword") String keyword,
    @Param("status") Integer status,
    @Param("tag") String tag,
    @Param("wordCountMin") Long wordCountMin,
    @Param("wordCountMax") Long wordCountMax,
    @Param("favoriteCountMin") Integer favoriteCountMin,   // æ–°å¢
    @Param("favoriteCountMax") Integer favoriteCountMax,   // æ–°å¢
    Pageable pageable);
```

---

### 3. FavoriteControlleræ–°å¢

```java
/**
 * æ‰¹é‡æŸ¥è¯¢æ”¶è—çŠ¶æ€
 */
@GetMapping("/check-batch")
public ResponseEntity<Map<String, Object>> checkBatchFavorites(
    @RequestParam String novelIds
) {
    // è§£ænovelIdsï¼ˆé€—å·åˆ†éš”ï¼‰
    List<Long> novelIdList = Arrays.stream(novelIds.split(","))
        .map(Long::valueOf)
        .collect(Collectors.toList());
    
    // è·å–å½“å‰ç”¨æˆ·
    Long userId = getCurrentUserId();
    if (userId == null) {
        return ResponseEntity.ok(Map.of(
            "success", true,
            "favorites", Collections.emptyMap()
        ));
    }
    
    // æ‰¹é‡æŸ¥è¯¢æ”¶è—çŠ¶æ€
    Map<Long, Boolean> favoriteMap = favoriteRepository
        .findByUserIdAndNovelIdIn(userId, novelIdList)
        .stream()
        .collect(Collectors.toMap(
            UserFavorite::getNovelId,
            f -> true
        ));
    
    // å¡«å……æœªæ”¶è—çš„å°è¯´
    for (Long novelId : novelIdList) {
        favoriteMap.putIfAbsent(novelId, false);
    }
    
    return ResponseEntity.ok(Map.of(
        "success", true,
        "favorites", favoriteMap
    ));
}
```

---

### 4. FavoriteServiceæ›´æ–°

#### æ”¶è—æ—¶æ›´æ–°favorite_count

```java
@Transactional
public Favorite addFavorite(Long userId, Long novelId, String category) {
    // 1. æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
    if (favoriteRepository.existsByUserIdAndNovelId(userId, novelId)) {
        throw new RuntimeException("å·²ç»æ”¶è—è¿‡äº†");
    }
    
    // 2. åˆ›å»ºæ”¶è—è®°å½•
    Favorite favorite = new Favorite();
    favorite.setUserId(userId);
    favorite.setNovelId(novelId);
    favorite.setCategory(category);
    favorite = favoriteRepository.save(favorite);
    
    // 3. æ›´æ–°å°è¯´çš„æ”¶è—æ•°
    Novel novel = novelRepository.findById(novelId)
        .orElseThrow(() -> new RuntimeException("å°è¯´ä¸å­˜åœ¨"));
    novel.setFavoriteCount(novel.getFavoriteCount() + 1);
    novelRepository.save(novel);
    
    return favorite;
}
```

#### å–æ¶ˆæ”¶è—æ—¶æ›´æ–°favorite_count

```java
@Transactional
public void removeFavorite(Long userId, Long novelId) {
    // 1. åˆ é™¤æ”¶è—è®°å½•
    Favorite favorite = favoriteRepository
        .findByUserIdAndNovelId(userId, novelId)
        .orElseThrow(() -> new RuntimeException("æœªæ”¶è—"));
    favoriteRepository.delete(favorite);
    
    // 2. æ›´æ–°å°è¯´çš„æ”¶è—æ•°
    Novel novel = novelRepository.findById(novelId)
        .orElseThrow(() -> new RuntimeException("å°è¯´ä¸å­˜åœ¨"));
    if (novel.getFavoriteCount() > 0) {
        novel.setFavoriteCount(novel.getFavoriteCount() - 1);
        novelRepository.save(novel);
    }
}
```

---

### 5. CrawlerControlleræ›´æ–°

#### æ‰©å±•getNovelsPageæ¥å£

```java
@GetMapping("/novels/page")
public ResponseEntity<Map<String, Object>> getNovelsPage(
    @RequestParam(defaultValue = "0") int page,
    @RequestParam(defaultValue = "10") int size,
    @RequestParam(required = false) String platform,
    @RequestParam(required = false) String keyword,
    @RequestParam(required = false) Integer status,
    @RequestParam(required = false) String tag,
    @RequestParam(required = false) String wordCountMin,
    @RequestParam(required = false) String wordCountMax,
    @RequestParam(required = false) Integer favoriteCountMin,   // æ–°å¢
    @RequestParam(required = false) Integer favoriteCountMax,   // æ–°å¢
    @RequestParam(defaultValue = "updateTime") String sortBy,
    @RequestParam(defaultValue = "desc") String sortOrder
) {
    // åˆ›å»ºSortå¯¹è±¡
    Sort sort = Sort.by(sortOrder.equals("desc") ? Sort.Direction.DESC : Sort.Direction.ASC, sortBy);
    
    // å¦‚æœsortByæ˜¯favoriteCountï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
    if ("favoriteCount".equals(sortBy)) {
        sort = Sort.by(sortOrder.equals("desc") ? Sort.Direction.DESC : Sort.Direction.ASC, "favoriteCount");
    }
    
    Pageable pageable = PageRequest.of(page, size, sort);
    
    // è°ƒç”¨RepositoryæŸ¥è¯¢
    Page<Novel> novelPage = novelRepository.searchNovels(
        platform, keyword, status, tag,
        parseWordCount(wordCountMin), parseWordCount(wordCountMax),
        favoriteCountMin, favoriteCountMax,  // æ–°å¢
        pageable
    );
    
    // è·å–å½“å‰ç”¨æˆ·ID
    Long userId = getCurrentUserId();
    
    // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œæ‰¹é‡æŸ¥è¯¢æ”¶è—çŠ¶æ€
    if (userId != null) {
        List<Long> novelIds = novelPage.getContent().stream()
            .map(Novel::getId)
            .collect(Collectors.toList());
        
        Map<Long, Boolean> favoriteMap = favoriteRepository
            .findByUserIdAndNovelIdIn(userId, novelIds)
            .stream()
            .collect(Collectors.toMap(
                UserFavorite::getNovelId,
                f -> true
            ));
        
        // è®¾ç½®æ¯æœ¬å°è¯´çš„æ”¶è—çŠ¶æ€
        novelPage.getContent().forEach(novel -> {
            novel.setIsFavorite(favoriteMap.getOrDefault(novel.getId(), false));
        });
    } else {
        // æœªç™»å½•ï¼Œè®¾ç½®isFavoriteä¸ºnull
        novelPage.getContent().forEach(novel -> novel.setIsFavorite(null));
    }
    
    // è¿”å›ç»“æœ
    return ResponseEntity.ok(Map.of(
        "content", novelPage.getContent(),
        "totalElements", novelPage.getTotalElements(),
        "totalPages", novelPage.getTotalPages(),
        "size", novelPage.getSize(),
        "number", novelPage.getNumber()
    ));
}
```

---

## ğŸ”‘ å‰ç«¯å®ç°ç»†èŠ‚

### 1. ç”¨æˆ·ç™»å½•çŠ¶æ€ç®¡ç†

åœ¨Vuexæˆ–Piniaä¸­ç®¡ç†ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼š

```javascript
// store/user.js
export const useUserStore = defineStore('user', {
  state: () => ({
    user: null,
    isLoggedIn: false
  }),
  getters: {
    isLoggedIn: (state) => state.isLoggedIn
  },
  actions: {
    setUser(user) {
      this.user = user;
      this.isLoggedIn = !!user;
    }
  }
});
```

---

### 2. æ‰¹é‡æŸ¥è¯¢æ”¶è—çŠ¶æ€

```javascript
// åœ¨Novels.vueä¸­
const loadFavoriteStatusBatch = async () => {
  const userStore = useUserStore();
  if (!userStore.isLoggedIn) {
    return;
  }
  
  const novelIds = novels.value.map(n => n.id).join(',');
  try {
    const response = await favoriteApi.checkBatchFavorites(novelIds);
    if (response.success && response.favorites) {
      novels.value.forEach(novel => {
        novel.isFavorite = response.favorites[novel.id] || false;
      });
    }
  } catch (error) {
    console.error('æ‰¹é‡æŸ¥è¯¢æ”¶è—çŠ¶æ€å¤±è´¥:', error);
  }
}

// åœ¨loadDataåè°ƒç”¨
const loadData = async () => {
  // ... åŠ è½½å°è¯´åˆ—è¡¨ ...
  await loadFavoriteStatusBatch();  // æ–°å¢
}
```

---

### 3. åˆ‡æ¢æ”¶è—çŠ¶æ€

```javascript
// åœ¨Novels.vueä¸­
const toggleFavorite = async (row) => {
  try {
    if (row.isFavorite) {
      // å–æ¶ˆæ”¶è—
      await favoriteApi.removeFavorite(row.id);
      row.isFavorite = false;
      row.favoriteCount = Math.max(0, row.favoriteCount - 1);
      ElMessage.success('å–æ¶ˆæ”¶è—æˆåŠŸ');
    } else {
      // æ·»åŠ æ”¶è—
      await favoriteApi.addFavorite({ novelId: row.id, category: 'default' });
      row.isFavorite = true;
      row.favoriteCount = (row.favoriteCount || 0) + 1;
      ElMessage.success('æ”¶è—æˆåŠŸ');
    }
  } catch (error) {
    console.error('åˆ‡æ¢æ”¶è—å¤±è´¥:', error);
    ElMessage.error(error.message || 'æ“ä½œå¤±è´¥');
  }
}
```

---

### 4. ç­›é€‰å’Œæ’åºæ›´æ–°

```javascript
const loadData = async () => {
  loading.value = true
  try {
    const params = {
      page: currentPage.value - 1,
      size: pageSize.value
    }
    
    // æ·»åŠ ç­›é€‰å‚æ•°
    if (filterPlatform.value) params.platform = filterPlatform.value
    if (searchKeyword.value) params.keyword = searchKeyword.value
    if (filterStatus.value !== '') params.status = filterStatus.value
    if (filterTag.value) params.tag = filterTag.value
    if (wordCountMin.value) params.wordCountMin = wordCountMin.value
    if (wordCountMax.value) params.wordCountMax = wordCountMax.value
    if (favoriteCountMin.value) params.favoriteCountMin = favoriteCountMin.value  // æ–°å¢
    if (sortBy.value) params.sortBy = sortBy.value
    if (sortOrder.value) params.sortOrder = sortOrder.value
    
    const data = await crawlerApi.getNovels(params)
    
    if (data.content) {
      novels.value = data.content
      total.value = data.totalElements
    }
  } catch (error) {
    console.error('åŠ è½½å°è¯´åˆ—è¡¨å¤±è´¥:', error)
  } finally {
    loading.value = false
  }
  
  // æ‰¹é‡æŸ¥è¯¢æ”¶è—çŠ¶æ€
  await loadFavoriteStatusBatch()
}
```

---

## ğŸ“Š æ•°æ®åº“è¿ç§»è„šæœ¬

```sql
-- V3__add_favorite_count.sql

-- æ·»åŠ æ”¶è—æ•°å­—æ®µ
ALTER TABLE t_novel ADD COLUMN favorite_count INT DEFAULT 0 COMMENT 'æ”¶è—æ•°' AFTER word_count;

-- æ·»åŠ æ”¶è—æ•°å­—æ®µç´¢å¼•
CREATE INDEX idx_favorite_count ON t_novel(favorite_count);

-- æ·»åŠ æ”¶è—æ•°+çŠ¶æ€å¤åˆç´¢å¼•ï¼ˆç”¨äºæŒ‰æ”¶è—æ•°ç­›é€‰å¹¶æŒ‰çŠ¶æ€æ’åºï¼‰
CREATE INDEX idx_status_favorite_count ON t_novel(status, favorite_count DESC);
```

---

## ğŸ§ª å•å…ƒæµ‹è¯•

### NovelRepositoryTest

```java
@Test
public void testSearchByFavoriteCount() {
    Page<Novel> page = novelRepository.searchNovels(
        null, null, null, null, null, null, 10, null, PageRequest.of(0, 10)
    );
    assertTrue(page.getContent().stream().allMatch(n -> n.getFavoriteCount() >= 10));
}

@Test
public void testSortByFavoriteCount() {
    Page<Novel> page = novelRepository.searchNovels(
        null, null, null, null, null, null, null, null,
        PageRequest.of(0, 10, Sort.by(Sort.Direction.DESC, "favoriteCount"))
    );
    assertEquals(10, page.getContent().size());
}
```

### FavoriteServiceTest

```java
@Test
public void testAddFavoriteShouldIncrementCount() {
    // Before
    Novel novel = novelRepository.findById(1L).orElse(null);
    int countBefore = novel.getFavoriteCount();
    
    // Add favorite
    favoriteService.addFavorite(1L, 1L, "default");
    
    // After
    novel = novelRepository.findById(1L).orElse(null);
    assertEquals(countBefore + 1, novel.getFavoriteCount());
}

@Test
public void testRemoveFavoriteShouldDecrementCount() {
    // Add favorite first
    favoriteService.addFavorite(1L, 1L, "default");
    
    // Before
    Novel novel = novelRepository.findById(1L).orElse(null);
    int countBefore = novel.getFavoriteCount();
    
    // Remove favorite
    favoriteService.removeFavorite(1L, 1L);
    
    // After
    novel = novelRepository.findById(1L).orElse(null);
    assertEquals(countBefore - 1, novel.getFavoriteCount());
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¹¶å‘é—®é¢˜

æ”¶è—æ•°çš„æ›´æ–°å¯èƒ½å­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œå»ºè®®ï¼š

1. ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
2. ä½¿ç”¨ä¹è§‚é”æˆ–æ‚²è§‚é”ï¼ˆå¦‚æœå¹¶å‘é‡é«˜ï¼‰
3. è€ƒè™‘ä½¿ç”¨Redisç¼“å­˜æ”¶è—æ•°ï¼Œå¼‚æ­¥æ›´æ–°åˆ°æ•°æ®åº“

### 2. æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡æŸ¥è¯¢æ”¶è—çŠ¶æ€**ï¼šä½¿ç”¨ `check-batch` æ¥å£ï¼Œé¿å…N+1æŸ¥è¯¢
2. **ç´¢å¼•ä¼˜åŒ–**ï¼šæ”¶è—æ•°å­—æ®µå·²å»ºç«‹ç´¢å¼•
3. **ç¼“å­˜**ï¼šå°è¯´åˆ—è¡¨å¯ä»¥ç¼“å­˜2åˆ†é’Ÿï¼ˆæ”¶è—æ•°å˜åŒ–é¢‘ç‡ä½ï¼‰

### 3. æƒé™æ§åˆ¶

1. **æœªç™»å½•ç”¨æˆ·**ï¼šåªèƒ½æŸ¥çœ‹æ”¶è—æ•°ï¼Œä¸èƒ½æ”¶è—/å–æ¶ˆæ”¶è—
2. **å·²ç™»å½•ç”¨æˆ·**ï¼šå¯ä»¥æ”¶è—/å–æ¶ˆæ”¶è—
3. **æ”¶è—çŠ¶æ€**ï¼šåªæ˜¾ç¤ºè‡ªå·±çš„æ”¶è—çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºå…¶ä»–ç”¨æˆ·çš„

### 4. é”™è¯¯å¤„ç†

1. æ”¶è—æ•°ä¸èƒ½ä¸ºè´Ÿæ•°
2. é‡å¤æ”¶è—éœ€è¦æç¤º
3. å–æ¶ˆä¸å­˜åœ¨çš„æ”¶è—éœ€è¦æç¤º

---

## ğŸ“ å®æ–½è®¡åˆ’

| é˜¶æ®µ | ä»»åŠ¡ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|------|------|--------|--------|
| ç¬¬ä¸€é˜¶æ®µ | æ•°æ®åº“è¿ç§» | 0.5h | P0 |
| ç¬¬ä¸€é˜¶æ®µ | Novelå®ä½“æ›´æ–° | 0.5h | P0 |
| ç¬¬ä¸€é˜¶æ®µ | NovelRepositoryæ›´æ–° | 0.5h | P0 |
| ç¬¬ä¸€é˜¶æ®µ | FavoriteControlleræ–°å¢ | 0.5h | P0 |
| ç¬¬ä¸€é˜¶æ®µ | FavoriteServiceæ›´æ–° | 0.5h | P0 |
| ç¬¬ä¸€é˜¶æ®µ | CrawlerControlleræ›´æ–° | 0.5h | P0 |
| ç¬¬äºŒé˜¶æ®µ | å‰ç«¯Novels.vueæ›´æ–° | 1.5h | P0 |
| ç¬¬äºŒé˜¶æ®µ | å‰ç«¯NovelDetail.vueæ›´æ–° | 1h | P0 |
| ç¬¬äºŒé˜¶æ®µ | APIæ¥å£æ›´æ–° | 0.5h | P0 |
| ç¬¬äºŒé˜¶æ®µ | Mockæ•°æ®æ›´æ–° | 0.5h | P0 |
| ç¬¬ä¸‰é˜¶æ®µ | åç«¯å•å…ƒæµ‹è¯• | 1h | P0 |
| ç¬¬ä¸‰é˜¶æ®µ | å‰åç«¯è”è°ƒ | 1h | P0 |
| ç¬¬ä¸‰é˜¶æ®µ | æ€§èƒ½æµ‹è¯• | 0.5h | P1 |

**æ€»è®¡**ï¼šçº¦9å°æ—¶

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] å°è¯´åˆ—è¡¨æ˜¾ç¤ºæ”¶è—æ•°
- [ ] å°è¯´è¯¦æƒ…é¡µæ˜¾ç¤ºæ”¶è—æ•°
- [ ] å·²ç™»å½•ç”¨æˆ·å¯ä»¥æ”¶è—/å–æ¶ˆæ”¶è—
- [ ] æ”¶è—/å–æ¶ˆæ”¶è—åæ”¶è—æ•°å®æ—¶æ›´æ–°
- [ ] å¯ä»¥æŒ‰æ”¶è—æ•°ç­›é€‰ï¼ˆ10+/50+/100+/500+/1000+ï¼‰
- [ ] å¯ä»¥æŒ‰æ”¶è—æ•°é™åºæ’åº
- [ ] æœªç™»å½•ç”¨æˆ·ä¸æ˜¾ç¤ºæ”¶è—æŒ‰é’®
- [ ] æ”¶è—çŠ¶æ€æ­£ç¡®æ˜¾ç¤ºï¼ˆå·²æ”¶è—/æœªæ”¶è—ï¼‰

### æ€§èƒ½éªŒæ”¶

- [ ] å°è¯´åˆ—è¡¨æŸ¥è¯¢ < 100ms
- [ ] æ‰¹é‡æŸ¥è¯¢æ”¶è—çŠ¶æ€ < 50ms
- [ ] æ”¶è—/å–æ¶ˆæ”¶è— < 200ms

### å…¼å®¹æ€§éªŒæ”¶

- [ ] æœªç™»å½•ç”¨æˆ·å¯ä»¥æ­£å¸¸æµè§ˆï¼ˆæ”¶è—æ•°æ­£å¸¸æ˜¾ç¤ºï¼‰
- [ ] å·²ç™»å½•ç”¨æˆ·æ”¶è—çŠ¶æ€æ­£ç¡®
- [ ] æ”¶è—æ•°å¹¶å‘æ›´æ–°æ­£ç¡®ï¼ˆç®€å•æµ‹è¯•ï¼‰

---

**æ–‡æ¡£ç»“æŸ**

è¯·è¯„å®¡æœ¬è®¾è®¡æ–‡æ¡£ï¼Œç¡®è®¤æ— è¯¯åæˆ‘å†è¿›è¡Œå¼€å‘ï¼ğŸ¦
