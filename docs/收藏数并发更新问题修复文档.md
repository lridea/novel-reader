# æ”¶è—æ•°å¹¶å‘æ›´æ–°é—®é¢˜ä¿®å¤æ–‡æ¡£

**ä¿®å¤æ—¶é—´**: 2026-02-18
**ä¿®å¤äººå‘˜**: OpenClaw
**ç‰ˆæœ¬**: v1.1
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### é—®é¢˜åœºæ™¯

å¤šä¸ªç”¨æˆ·åŒæ—¶æ”¶è—åŒä¸€æœ¬ä¹¦æ—¶ï¼Œä½¿ç”¨Javaå±‚é¢è®¡ç®—favoriteCount+1ä¼šå¯¼è‡´ä¸¢å¤±æ›´æ–°ã€‚

### å¹¶å‘å†²çªç¤ºä¾‹

å‡è®¾å°è¯´Xçš„å½“å‰æ”¶è—æ•°ä¸º0ï¼š

| æ—¶é—´ | ç”¨æˆ·A | ç”¨æˆ·B | æ•°æ®åº“æ”¶è—æ•° |
|------|-------|-------|-------------|
| T1 | è¯»å–æ”¶è—æ•°ï¼š0 | è¯»å–æ”¶è—æ•°ï¼š0 | 0 |
| T2 | è®¡ç®—ï¼š0+1=1 | è®¡ç®—ï¼š0+1=1 | 0 |
| T3 | æ›´æ–°æ”¶è—æ•°ï¼š1 | ç­‰å¾…ä¸­... | 1ï¼ˆç”¨æˆ·Aï¼‰ |
| T4 | ç­‰å¾…ä¸­... | æ›´æ–°æ”¶è—æ•°ï¼š1 | 1ï¼ˆç”¨æˆ·Bï¼Œè¦†ç›–äº†ç”¨æˆ·Açš„æ›´æ–°ï¼‰ |

**ç»“æœ**ï¼šæœ€ç»ˆæ”¶è—æ•°ä¸º1ï¼Œä½†å®é™…åº”è¯¥æ˜¯2ï¼ˆä¸¢å¤±äº†ä¸€ä¸ªæ›´æ–°ï¼‰

### æ—§çš„å®ç°ä»£ç 

```java
@Transactional
public Map<String, Object> addFavorite(Long userId, Long novelId, String note) {
    // ... åˆ›å»ºæ”¶è—è®°å½• ...

    // æ›´æ–°å°è¯´çš„æ”¶è—æ•°ï¼ˆå­˜åœ¨é—®é¢˜ï¼‰
    novel.setFavoriteCount(novel.getFavoriteCount() + 1);
    novelRepository.save(novel);
}
```

**é—®é¢˜**ï¼š`novel.getFavoriteCount() + 1` æ˜¯åœ¨Javaå±‚é¢è®¡ç®—ï¼Œå¦‚æœå¤šä¸ªç”¨æˆ·åŒæ—¶æ‰§è¡Œï¼Œä¼šè¯»å–åˆ°ç›¸åŒçš„å€¼ã€‚

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‰æ‹© |
|------|------|------|------|
| æ–¹æ¡ˆ1ï¼šæ•°æ®åº“å±‚é¢åŸå­æ“ä½œ | åŸå­æ“ä½œï¼Œæ€§èƒ½å¥½ï¼Œæ— éœ€é¢å¤–å­—æ®µ | - | âœ… æ¨è |
| æ–¹æ¡ˆ2ï¼šä¹è§‚é” | é¿å…æ•°æ®åº“é” | éœ€è¦é‡è¯•æœºåˆ¶ï¼Œå†²çªé¢‘ç‡é«˜æ—¶æ€§èƒ½ä¸‹é™ | - |
| æ–¹æ¡ˆ3ï¼šæ‚²è§‚é” | ä¸ä¼šä¸¢å¤±æ›´æ–° | æ•°æ®åº“é”ï¼Œå½±å“å¹¶å‘æ€§èƒ½ | - |

**é€‰æ‹©æ–¹æ¡ˆ1**ï¼šä½¿ç”¨æ•°æ®åº“å±‚é¢çš„åŸå­æ“ä½œ `UPDATE favorite_count = favorite_count + 1`

---

## ğŸ“ ä¿®å¤ä»£ç 

### 1. NovelRepositoryæ–°å¢æ–¹æ³•

```java
/**
 * åŸå­æ“ä½œï¼šæ”¶è—æ•°+1
 */
@Modifying
@Query("UPDATE Novel n SET n.favoriteCount = n.favoriteCount + 1 WHERE n.id = :novelId")
@Transactional
void incrementFavoriteCount(@Param("novelId") Long novelId);

/**
 * åŸå­æ“ä½œï¼šæ”¶è—æ•°-1
 */
@Modifying
@Query("UPDATE Novel n SET n.favoriteCount = n.favoriteCount - 1 WHERE n.id = :novelId AND n.favoriteCount > 0")
@Transactional
void decrementFavoriteCount(@Param("novelId") Long novelId);
```

**å…³é”®ç‚¹**ï¼š
- `@Modifying`ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªä¿®æ”¹æ“ä½œ
- `@Query`ï¼šä½¿ç”¨JPQLçš„UPDATEè¯­å¥
- `n.favoriteCount = n.favoriteCount + 1`ï¼šæ•°æ®åº“å±‚é¢åŸå­æ“ä½œ
- `@Transactional`ï¼šç¡®ä¿äº‹åŠ¡ä¸€è‡´æ€§
- `decrementFavoriteCount`ï¼šæ·»åŠ `AND n.favoriteCount > 0`æ¡ä»¶ï¼Œé˜²æ­¢æ”¶è—æ•°å˜ä¸ºè´Ÿæ•°

---

### 2. FavoriteServiceæ›´æ–°

#### addFavoriteæ–¹æ³•

```java
@Transactional
public Map<String, Object> addFavorite(Long userId, Long novelId, String note) {
    log.info("æ·»åŠ æ”¶è—: userId={}, novelId={}", userId, novelId);

    Map<String, Object> result = new HashMap<>();

    // æ£€æŸ¥å°è¯´æ˜¯å¦å­˜åœ¨
    Optional<Novel> novelOpt = novelRepository.findById(novelId);
    if (novelOpt.isEmpty()) {
        result.put("success", false);
        result.put("message", "å°è¯´ä¸å­˜åœ¨");
        return result;
    }

    Novel novel = novelOpt.get();

    // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
    if (favoriteRepository.existsByUserIdAndNovelId(userId, novelId)) {
        result.put("success", false);
        result.put("message", "å·²æ”¶è—è¯¥å°è¯´");
        return result;
    }

    // åˆ›å»ºæ”¶è—
    Favorite favorite = new Favorite();
    favorite.setUserId(userId);
    favorite.setNovelId(novelId);
    favorite.setPlatform(novel.getPlatform());
    favorite.setPlatformNovelId(novel.getNovelId());
    favorite.setNote(note);
    favorite.setLatestChapterTitle(novel.getLatestChapterTitle());
    favorite.setLatestUpdateTime(novel.getLatestUpdateTime());
    favorite.setHasUpdate(0);

    Favorite savedFavorite = favoriteRepository.save(favorite);

    // ä½¿ç”¨åŸå­æ“ä½œæ›´æ–°æ”¶è—æ•°ï¼ˆè§£å†³å¹¶å‘é—®é¢˜ï¼‰
    novelRepository.incrementFavoriteCount(novelId);

    // é‡æ–°è·å–æœ€æ–°çš„æ”¶è—æ•°
    Novel updatedNovel = novelRepository.findById(novelId).orElse(null);

    result.put("success", true);
    result.put("message", "æ”¶è—æˆåŠŸ");
    result.put("favorite", toFavoriteInfo(savedFavorite));
    result.put("novelFavoriteCount", updatedNovel != null ? updatedNovel.getFavoriteCount() : 0);

    return result;
}
```

**å…³é”®ä¿®æ”¹**ï¼š
- åˆ é™¤ï¼š`novel.setFavoriteCount(novel.getFavoriteCount() + 1);`
- åˆ é™¤ï¼š`novelRepository.save(novel);`
- æ–°å¢ï¼š`novelRepository.incrementFavoriteCount(novelId);`
- æ–°å¢ï¼š`Novel updatedNovel = novelRepository.findById(novelId).orElse(null);`

---

#### removeFavoriteæ–¹æ³•

```java
@Transactional
public Map<String, Object> removeFavorite(Long userId, Long novelId) {
    log.info("å–æ¶ˆæ”¶è—: userId={}, novelId={}", userId, novelId);

    Map<String, Object> result = new HashMap<>();

    // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
    if (!favoriteRepository.existsByUserIdAndNovelId(userId, novelId)) {
        result.put("success", false);
        result.put("message", "æœªæ”¶è—è¯¥å°è¯´");
        return result;
    }

    // ä½¿ç”¨åŸå­æ“ä½œæ›´æ–°æ”¶è—æ•°ï¼ˆè§£å†³å¹¶å‘é—®é¢˜ï¼‰
    novelRepository.decrementFavoriteCount(novelId);

    // åˆ é™¤æ”¶è—
    favoriteRepository.deleteByUserIdAndNovelId(userId, novelId);

    // é‡æ–°è·å–æœ€æ–°çš„æ”¶è—æ•°
    Novel updatedNovel = novelRepository.findById(novelId).orElse(null);

    result.put("success", true);
    result.put("message", "å–æ¶ˆæˆåŠŸ");
    result.put("novelFavoriteCount", updatedNovel != null ? updatedNovel.getFavoriteCount() : 0);

    return result;
}
```

**å…³é”®ä¿®æ”¹**ï¼š
- åˆ é™¤ï¼šå…ˆæŸ¥è¯¢å°è¯´ï¼Œç„¶åæ›´æ–°æ”¶è—æ•°
- åˆ é™¤ï¼šæ£€æŸ¥favoriteCount > 0çš„é€»è¾‘ï¼ˆç§»åˆ°SQLä¸­ï¼‰
- æ–°å¢ï¼š`novelRepository.decrementFavoriteCount(novelId);`
- æ–°å¢ï¼šå…ˆæ›´æ–°æ”¶è—æ•°ï¼Œå†åˆ é™¤æ”¶è—è®°å½•
- æ–°å¢ï¼šé‡æ–°è·å–æœ€æ–°çš„æ”¶è—æ•°

---

## âœ… ä¿®å¤æ•ˆæœ

### å¹¶å‘æµ‹è¯•åœºæ™¯

å‡è®¾å°è¯´Xçš„å½“å‰æ”¶è—æ•°ä¸º0ï¼š

| æ—¶é—´ | ç”¨æˆ·A | ç”¨æˆ·B | æ•°æ®åº“æ”¶è—æ•° |
|------|-------|-------|-------------|
| T1 | åˆ›å»ºæ”¶è—è®°å½• | åˆ›å»ºæ”¶è—è®°å½• | 0 |
| T2 | åŸå­æ“ä½œï¼šUPDATE favorite_count = favorite_count + 1 | åŸå­æ“ä½œï¼šUPDATE favorite_count = favorite_count + 1 | 0 |
| T3 | ç­‰å¾…ä¸­... | 1ï¼ˆç”¨æˆ·Bï¼‰ | 1 |
| T4 | 2ï¼ˆç”¨æˆ·Aï¼‰ | - | 2 |

**ç»“æœ**ï¼šæœ€ç»ˆæ”¶è—æ•°ä¸º2ï¼Œä¸¤ä¸ªæ›´æ–°éƒ½ç”Ÿæ•ˆï¼Œæ²¡æœ‰ä¸¢å¤±æ›´æ–°ï¼

---

## ğŸ¯ ä¼˜ç‚¹

### åŸå­æ“ä½œ
- âœ… ä¸ä¼šä¸¢å¤±æ›´æ–°
- âœ… æ•°æ®åº“å±‚é¢ä¿è¯ä¸€è‡´æ€§

### æ€§èƒ½
- âœ… æ€§èƒ½å¥½ï¼Œä¸éœ€è¦é”
- âœ… MySQLçš„`UPDATE count = count + 1`æœ¬èº«å°±æ˜¯åŸå­æ“ä½œ

### å®ç°
- âœ… å®ç°ç®€å•ï¼Œæ— éœ€é¢å¤–å­—æ®µ
- âœ… ä»£ç æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤

---

## ğŸ“Š ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `NovelRepository.java` | æ–°å¢incrementFavoriteCountå’ŒdecrementFavoriteCountæ–¹æ³• |
| `FavoriteService.java` | ä½¿ç”¨åŸå­æ“ä½œæ›´æ–°æ”¶è—æ•° |

---

## ğŸ” æµ‹è¯•å»ºè®®

### å¹¶å‘æµ‹è¯•

ä½¿ç”¨JMeteræˆ–ç±»ä¼¼å·¥å…·è¿›è¡Œå¹¶å‘æµ‹è¯•ï¼š

```bash
# 100ä¸ªç”¨æˆ·åŒæ—¶æ”¶è—åŒä¸€æœ¬ä¹¦
# é¢„æœŸç»“æœï¼šæ”¶è—æ•°=100
```

### å•å…ƒæµ‹è¯•

```java
@Test
public void testConcurrentAddFavorite() throws InterruptedException {
    Long novelId = 1L;
    int threadCount = 100;
    CountDownLatch latch = new CountDownLatch(threadCount);
    ExecutorService executor = Executors.newFixedThreadPool(threadCount);
    
    // è·å–åˆå§‹æ”¶è—æ•°
    Novel novel = novelRepository.findById(novelId).orElse(null);
    int initialCount = novel.getFavoriteCount();
    
    // 100ä¸ªçº¿ç¨‹åŒæ—¶æ”¶è—
    for (int i = 0; i < threadCount; i++) {
        final int userId = i + 1;
        executor.submit(() -> {
            try {
                favoriteService.addFavorite((long) userId, novelId, "");
            } catch (Exception e) {
                // é¢„æœŸä¼šæœ‰é‡å¤æ”¶è—çš„å¼‚å¸¸
            } finally {
                latch.countDown();
            }
        });
    }
    
    latch.await(30, TimeUnit.SECONDS);
    
    // è·å–æœ€ç»ˆæ”¶è—æ•°
    novel = novelRepository.findById(novelId).orElse(null);
    int finalCount = novel.getFavoriteCount();
    
    // éªŒè¯ï¼šæ”¶è—æ•°åº”è¯¥=åˆå§‹æ”¶è—æ•°+100
    assertEquals(initialCount + threadCount, finalCount);
}
```

---

## ğŸ¯ Gitæäº¤è®°å½•

| æäº¤ID | æäº¤ä¿¡æ¯ | æ—¶é—´ |
|--------|---------|------|
| d2a4852 | fix: ä½¿ç”¨åŸå­æ“ä½œè§£å†³æ”¶è—æ•°å¹¶å‘æ›´æ–°é—®é¢˜ | 12:20 |

### GitHubæ¨é€è®°å½•

- **ä»“åº“**: https://github.com/lridea/novel-reader
- **åˆ†æ”¯**: master
- **æœ€æ–°æäº¤**: d2a4852

---

## ğŸ“Œ æ€»ç»“

### é—®é¢˜
- âš ï¸ å¤šä¸ªç”¨æˆ·åŒæ—¶æ”¶è—æ—¶ï¼Œä¼šä¸¢å¤±æ›´æ–°
- âš ï¸ æ”¶è—æ•°å¯èƒ½ä¸å‡†ç¡®

### è§£å†³æ–¹æ¡ˆ
- âœ… ä½¿ç”¨æ•°æ®åº“å±‚é¢çš„åŸå­æ“ä½œ
- âœ… `UPDATE t_novel SET favorite_count = favorite_count + 1 WHERE id = ?`

### ä¿®å¤æ•ˆæœ
- âœ… ä¸ä¼šä¸¢å¤±æ›´æ–°
- âœ… æ”¶è—æ•°å‡†ç¡®
- âœ… æ€§èƒ½å¥½ï¼Œæ— éœ€é¢å¤–é”

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-02-18 12:20  
**ä¿®å¤äººå‘˜**: OpenClaw  
**GitHubä»“åº“**: https://github.com/lridea/novel-reader  
**æœ€æ–°æäº¤**: d2a4852  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  

ğŸ¦
