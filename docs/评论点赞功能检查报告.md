# è¯„è®ºç‚¹èµåŠŸèƒ½æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¥æœŸ**: 2026-02-18
**æ£€æŸ¥äººå‘˜**: OpenClaw
**æ£€æŸ¥å†…å®¹**: è¯„è®ºç‚¹èµæ˜¯å¦æ˜¯ä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡åŒä¸€ä¸ªè¯„è®º

---

## âœ… æ£€æŸ¥ç»“æœ

**ç»“è®º**: âœ… **å·²å®ç°ä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡åŒä¸€ä¸ªè¯„è®ºçš„åŠŸèƒ½**

---

## ğŸ“‹ å®ç°æ–¹å¼

### 1. æ•°æ®åº“å±‚é¢ï¼ˆåŒé‡ä¿éšœï¼‰

#### CommentLikeå®ä½“ç±»

```java
@Data
@Entity
@Table(name = "t_comment_like", indexes = {
    @Index(name = "idx_user_id", columnList = "userId"),
    @Index(name = "idx_comment_id", columnList = "commentId")
}, uniqueConstraints = {
    @UniqueConstraint(name = "uk_user_comment", columnNames = {"userId", "commentId"})
})
public class CommentLike {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /**
     * ç”¨æˆ·ID
     */
    @Column(nullable = false)
    private Long userId;

    /**
     * è¯„è®ºID
     */
    @Column(nullable = false)
    private Long commentId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;
}
```

**å…³é”®ç‚¹**ï¼š
- `@UniqueConstraint(name = "uk_user_comment", columnNames = {"userId", "commentId"})`ï¼šå”¯ä¸€çº¦æŸï¼Œç¡®ä¿åŒä¸€ä¸ªç”¨æˆ·å¯¹åŒä¸€ä¸ªè¯„è®ºåªèƒ½æœ‰ä¸€æ¡è®°å½•
- `@Index(name = "idx_user_id", columnList = "userId")`ï¼šç”¨æˆ·IDç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
- `@Index(name = "idx_comment_id", columnList = "commentId")`ï¼šè¯„è®ºIDç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡

---

### 2. åº”ç”¨å±‚é¢ï¼ˆä¸šåŠ¡é€»è¾‘æ£€æŸ¥ï¼‰

#### CommentService.likeCommentæ–¹æ³•

```java
/**
 * ç‚¹èµè¯„è®º
 */
@Transactional
public Map<String, Object> likeComment(Long userId, Long commentId) {
    log.info("ç‚¹èµè¯„è®º: userId={}, commentId={}", userId, commentId);

    Map<String, Object> result = new HashMap<>();

    // æ£€æŸ¥è¯„è®ºæ˜¯å¦å­˜åœ¨
    Optional<Comment> commentOpt = commentRepository.findById(commentId);
    if (commentOpt.isEmpty()) {
        result.put("success", false);
        result.put("message", "è¯„è®ºä¸å­˜åœ¨");
        return result;
    }

    Comment comment = commentOpt.get();

    // âœ… æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
    boolean exists = commentLikeRepository.existsByUserIdAndCommentId(userId, commentId);
    if (exists) {
        result.put("success", false);
        result.put("message", "å·²ç‚¹èµè¯¥è¯„è®º");
        result.put("liked", true);
        result.put("commentLikeCount", comment.getLikeCount());
        return result;
    }

    // åˆ›å»ºç‚¹èµè®°å½•
    CommentLike commentLike = new CommentLike();
    commentLike.setUserId(userId);
    commentLike.setCommentId(commentId);
    commentLikeRepository.save(commentLike);

    // æ›´æ–°è¯„è®ºçš„ç‚¹èµæ•°ï¼ˆåŸå­æ“ä½œï¼‰
    commentRepository.incrementLikeCount(commentId);

    // é‡æ–°è·å–æœ€æ–°çš„ç‚¹èµæ•°
    Comment updatedComment = commentRepository.findById(commentId).orElse(null);

    result.put("success", true);
    result.put("message", "ç‚¹èµæˆåŠŸ");
    result.put("liked", true);
    result.put("commentLikeCount", updatedComment != null ? updatedComment.getLikeCount() : 0);

    return result;
}
```

**å…³é”®ç‚¹**ï¼š
- `existsByUserIdAndCommentId(userId, commentId)`ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµè¯¥è¯„è®º
- å¦‚æœå·²ç‚¹èµï¼Œè¿”å›é”™è¯¯ï¼š"å·²ç‚¹èµè¯¥è¯„è®º"
- å¦‚æœæœªç‚¹èµï¼Œåˆ›å»ºç‚¹èµè®°å½•å¹¶æ›´æ–°ç‚¹èµæ•°

---

#### CommentService.unlikeCommentæ–¹æ³•

```java
/**
 * å–æ¶ˆç‚¹èµè¯„è®º
 */
@Transactional
public Map<String, Object> unlikeComment(Long userId, Long commentId) {
    log.info("å–æ¶ˆç‚¹èµè¯„è®º: userId={}, commentId={}", userId, commentId);

    Map<String, Object> result = new HashMap<>();

    // æ£€æŸ¥è¯„è®ºæ˜¯å¦å­˜åœ¨
    Optional<Comment> commentOpt = commentRepository.findById(commentId);
    if (commentOpt.isEmpty()) {
        result.put("success", false);
        result.put("message", "è¯„è®ºä¸å­˜åœ¨");
        return result;
    }

    Comment comment = commentOpt.get();

    // âœ… æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
    boolean exists = commentLikeRepository.existsByUserIdAndCommentId(userId, commentId);
    if (!exists) {
        result.put("success", false);
        result.put("message", "æœªç‚¹èµè¯¥è¯„è®º");
        result.put("liked", false);
        result.put("commentLikeCount", comment.getLikeCount());
        return result;
    }

    // åˆ é™¤ç‚¹èµè®°å½•
    commentLikeRepository.deleteByUserIdAndCommentId(userId, commentId);

    // æ›´æ–°è¯„è®ºçš„ç‚¹èµæ•°ï¼ˆåŸå­æ“ä½œï¼‰
    commentRepository.decrementLikeCount(commentId);

    // é‡æ–°è·å–æœ€æ–°çš„ç‚¹èµæ•°
    Comment updatedComment = commentRepository.findById(commentId).orElse(null);

    result.put("success", true);
    result.put("message", "å–æ¶ˆç‚¹èµæˆåŠŸ");
    result.put("liked", false);
    result.put("commentLikeCount", updatedComment != null ? updatedComment.getLikeCount() : 0);

    return result;
}
```

**å…³é”®ç‚¹**ï¼š
- `existsByUserIdAndCommentId(userId, commentId)`ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµè¯¥è¯„è®º
- å¦‚æœæœªç‚¹èµï¼Œè¿”å›é”™è¯¯ï¼š"æœªç‚¹èµè¯¥è¯„è®º"
- å¦‚æœå·²ç‚¹èµï¼Œåˆ é™¤ç‚¹èµè®°å½•å¹¶å‡å°‘ç‚¹èµæ•°

---

#### CommentLikeRepository

```java
/**
 * è¯„è®ºç‚¹èµRepository
 */
@Repository
public interface CommentLikeRepository extends JpaRepository<CommentLike, Long> {

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµè¯„è®º
     */
    Optional<CommentLike> findByUserIdAndCommentId(Long userId, Long commentId);

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµè¯„è®ºï¼ˆæ˜¯å¦å­˜åœ¨ï¼‰
     */
    boolean existsByUserIdAndCommentId(Long userId, Long commentId);

    /**
     * åˆ é™¤ç‚¹èµè®°å½•
     */
    void deleteByUserIdAndCommentId(Long userId, Long commentId);
}
```

**å…³é”®ç‚¹**ï¼š
- `existsByUserIdAndCommentId(userId, commentId)`ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµè¯¥è¯„è®º
- `deleteByUserIdAndCommentId(userId, commentId)`ï¼šåˆ é™¤ç‚¹èµè®°å½•

---

## ğŸ”’ åŒé‡ä¿éšœæœºåˆ¶

### ä¿éšœ1ï¼šåº”ç”¨å±‚é¢

**æ–¹å¼**ï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ

**ä¼˜ç‚¹**ï¼š
- æå‰æ£€æŸ¥ï¼Œé¿å…ä¸å¿…è¦çš„æ•°æ®åº“æ“ä½œ
- æä¾›å‹å¥½çš„é”™è¯¯æç¤º
- å‡å°‘æ•°æ®åº“å‹åŠ›

**ç¼ºç‚¹**ï¼š
- åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹å¯èƒ½å‡ºç°ç«æ€æ¡ä»¶

---

### ä¿éšœ2ï¼šæ•°æ®åº“å±‚é¢

**æ–¹å¼**ï¼šå”¯ä¸€çº¦æŸ`uk_user_comment`

**ä¼˜ç‚¹**ï¼š
- ç»å¯¹å®‰å…¨ï¼Œé¿å…é‡å¤ç‚¹èµ
- æ”¯æŒé«˜å¹¶å‘åœºæ™¯
- æ•°æ®å®Œæ•´æ€§æœ‰ä¿éšœ

**ç¼ºç‚¹**ï¼š
- å¦‚æœåº”ç”¨å±‚é¢æ£€æŸ¥å¤±è´¥ï¼Œä¼šæŠ›å‡ºæ•°æ®åº“å¼‚å¸¸
- éœ€è¦å¤„ç†æ•°æ®åº“å¼‚å¸¸

---

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡ç‚¹èµ

**æ“ä½œ**ï¼šç”¨æˆ·Aç‚¹èµè¯„è®ºB

**æµç¨‹**ï¼š
1. æ£€æŸ¥è¯„è®ºæ˜¯å¦å­˜åœ¨ âœ…
2. æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ âœ…ï¼ˆæœªç‚¹èµï¼‰
3. åˆ›å»ºç‚¹èµè®°å½• âœ…
4. æ›´æ–°ç‚¹èµæ•° âœ…

**ç»“æœ**ï¼šç‚¹èµæˆåŠŸ âœ…

---

### åœºæ™¯2ï¼šé‡å¤ç‚¹èµ

**æ“ä½œ**ï¼šç”¨æˆ·Aå†æ¬¡ç‚¹èµè¯„è®ºB

**æµç¨‹**ï¼š
1. æ£€æŸ¥è¯„è®ºæ˜¯å¦å­˜åœ¨ âœ…
2. æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ âœ…ï¼ˆå·²ç‚¹èµï¼‰
3. è¿”å›é”™è¯¯ï¼š"å·²ç‚¹èµè¯¥è¯„è®º"

**ç»“æœ**ï¼šç‚¹èµå¤±è´¥ âœ…

---

### åœºæ™¯3ï¼šå–æ¶ˆç‚¹èµ

**æ“ä½œ**ï¼šç”¨æˆ·Aå–æ¶ˆç‚¹èµè¯„è®ºB

**æµç¨‹**ï¼š
1. æ£€æŸ¥è¯„è®ºæ˜¯å¦å­˜åœ¨ âœ…
2. æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ âœ…ï¼ˆå·²ç‚¹èµï¼‰
3. åˆ é™¤ç‚¹èµè®°å½• âœ…
4. å‡å°‘ç‚¹èµæ•° âœ…

**ç»“æœ**ï¼šå–æ¶ˆç‚¹èµæˆåŠŸ âœ…

---

### åœºæ™¯4ï¼šå–æ¶ˆä¸å­˜åœ¨çš„ç‚¹èµ

**æ“ä½œ**ï¼šç”¨æˆ·Aå–æ¶ˆç‚¹èµæœªç‚¹èµçš„è¯„è®ºB

**æµç¨‹**ï¼š
1. æ£€æŸ¥è¯„è®ºæ˜¯å¦å­˜åœ¨ âœ…
2. æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ âœ…ï¼ˆæœªç‚¹èµï¼‰
3. è¿”å›é”™è¯¯ï¼š"æœªç‚¹èµè¯¥è¯„è®º"

**ç»“æœ**ï¼šå–æ¶ˆç‚¹èµå¤±è´¥ âœ…

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é«˜å¹¶å‘åœºæ™¯

**é—®é¢˜**ï¼šåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œåº”ç”¨å±‚é¢çš„æ£€æŸ¥å¯èƒ½å¤±æ•ˆã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ•°æ®åº“å±‚é¢çš„å”¯ä¸€çº¦æŸå·²ç»ç¡®ä¿äº†æ•°æ®å®Œæ•´æ€§
- å¯ä»¥æ·»åŠ åˆ†å¸ƒå¼é”æ¥è¿›ä¸€æ­¥ä¼˜åŒ–

---

### 2. é”™è¯¯å¤„ç†

**å½“å‰çŠ¶æ€**ï¼š
- åº”ç”¨å±‚é¢æ£€æŸ¥å¤±è´¥ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯
- æ•°æ®åº“å±‚é¢æ£€æŸ¥å¤±è´¥ï¼ˆå”¯ä¸€çº¦æŸè¿åï¼‰ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸

**å»ºè®®**ï¼š
- æ·»åŠ å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œå¤„ç†æ•°æ®åº“å¼‚å¸¸
- ç»Ÿä¸€é”™è¯¯æç¤º

---

### 3. äº‹åŠ¡ç®¡ç†

**å½“å‰çŠ¶æ€**ï¼š
- `@Transactional`æ³¨è§£ç¡®ä¿ç‚¹èµæ“ä½œæ˜¯åŸå­çš„

**ä¼˜ç‚¹**ï¼š
- ç‚¹èµè®°å½•åˆ›å»ºå’Œç‚¹èµæ•°æ›´æ–°åœ¨åŒä¸€äº‹åŠ¡ä¸­
- è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥

---

## ğŸ“Š ä»£ç è´¨é‡

### ä¼˜ç‚¹

âœ… **åŒé‡ä¿éšœ**ï¼šåº”ç”¨å±‚é¢+æ•°æ®åº“å±‚é¢
âœ… **äº‹åŠ¡ç®¡ç†**ï¼šä½¿ç”¨`@Transactional`æ³¨è§£
âœ… **ç´¢å¼•ä¼˜åŒ–**ï¼šuserIdå’ŒcommentIdéƒ½æœ‰ç´¢å¼•
âœ… **å”¯ä¸€çº¦æŸ**ï¼šæ•°æ®åº“å±‚é¢ç¡®ä¿å”¯ä¸€æ€§
âœ… **é”™è¯¯æç¤º**ï¼šæä¾›å‹å¥½çš„é”™è¯¯æ¶ˆæ¯

---

### å¯ä¼˜åŒ–ç‚¹

âš ï¸ **åˆ†å¸ƒå¼é”**ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹å¯ä»¥æ·»åŠ åˆ†å¸ƒå¼é”
âš ï¸ **å¼‚å¸¸å¤„ç†**ï¼šå¯ä»¥æ·»åŠ å…¨å±€å¼‚å¸¸å¤„ç†å™¨
âš ï¸ **æ—¥å¿—è®°å½•**ï¼šå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•

---

## ğŸ“ æ€»ç»“

### å®ç°æƒ…å†µ

âœ… **å·²å®ç°ä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡åŒä¸€ä¸ªè¯„è®ºçš„åŠŸèƒ½**

### å®ç°æ–¹å¼

1. **æ•°æ®åº“å±‚é¢**ï¼šå”¯ä¸€çº¦æŸ`uk_user_comment`
2. **åº”ç”¨å±‚é¢**ï¼šä¸šåŠ¡é€»è¾‘æ£€æŸ¥`existsByUserIdAndCommentId`

### åŒé‡ä¿éšœ

1. **åº”ç”¨å±‚é¢æ£€æŸ¥**ï¼šæå‰æ£€æŸ¥ï¼Œæä¾›å‹å¥½é”™è¯¯æç¤º
2. **æ•°æ®åº“å±‚é¢çº¦æŸ**ï¼šç»å¯¹å®‰å…¨ï¼Œé¿å…é‡å¤ç‚¹èµ

---

**æ£€æŸ¥å®Œæˆæ—¶é—´**: 2026-02-18 18:10
**æ£€æŸ¥äººå‘˜**: OpenClaw
**æ£€æŸ¥ç»“æœ**: âœ… è¯„è®ºç‚¹èµåŠŸèƒ½å·²æ­£ç¡®å®ç°

ğŸ¦
